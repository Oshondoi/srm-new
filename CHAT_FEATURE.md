# Chat Feature - Переписка в сделках

## Описание
Добавлена полноценная функция переписки в модалке сделок, реализованная в стиле amoCRM.

## Где находится
**Файл:** `/workspaces/srm-new/src/components/DealModal.tsx`  
**Вкладка:** "Переписка" (последняя вкладка в модалке сделки)

## Основные возможности

### ✅ Реализовано

1. **Отправка и получение сообщений**
   - Отображение сообщений в виде пузырей (bubbles)
   - Свои сообщения справа (синий цвет)
   - Чужие сообщения слева (серый цвет)

2. **UI компоненты**
   - Textarea для ввода сообщений (2 строки)
   - Кнопка отправки с иконкой ✉️
   - Счетчик сообщений на вкладке
   - Автопрокрутка к последнему сообщению

3. **Клавиатурные сокращения**
   - `Enter` - отправить сообщение
   - `Shift+Enter` - новая строка в сообщении

4. **Метаданные сообщений**
   - Имя отправителя
   - Время отправки (HH:MM)
   - Разделение на свои/чужие

5. **Демо-данные**
   - При первом открытии чата загружаются 2 демо-сообщения
   - Все сообщения сохраняются в localStorage

## Структура данных

### Формат сообщения
```typescript
{
  id: string,           // Уникальный ID
  text: string,         // Текст сообщения
  sender: string,       // Имя отправителя
  timestamp: string,    // ISO timestamp
  isOwn: boolean        // true - свое, false - чужое
}
```

### Хранение
- **Текущее:** localStorage с ключом `deal-chat-${dealId}`
- **Будущее:** API endpoint для сохранения в БД

## UI/UX детали

### Макет
```
┌─────────────────────────────────────┐
│        Переписка (2) ◄─ Счетчик    │
├─────────────────────────────────────┤
│                                     │
│  ┌──────────────┐                  │  ◄─ Чужое сообщение
│  │ Петр Петрович│                  │
│  │ Текст...     │                  │
│  │ 12:30        │                  │
│  └──────────────┘                  │
│                                     │
│                  ┌──────────────┐  │  ◄─ Свое сообщение
│                  │ Текст...     │  │
│                  │ 12:35        │  │
│                  └──────────────┘  │
│                                     │
├─────────────────────────────────────┤
│ ┌──────────────────┐  ┌─────────┐ │
│ │ Введите текст... │  │ ✉️ Btn  │ │
│ └──────────────────┘  └─────────┘ │
│ Enter - отправить, Shift+Enter - →│
└─────────────────────────────────────┘
```

### Цветовая схема
- **Свои сообщения:** `bg-blue-600` (синий)
- **Чужие сообщения:** `bg-slate-700` (серый)
- **Фон:** `bg-slate-800` (темный)
- **Счетчик:** `bg-blue-600` с белым текстом

### Высота
- Динамическая: `calc(100vh - 280px)`
- Автопрокрутка при новых сообщениях
- overflow-y-auto для скролла

## Технические детали

### React Hooks
```typescript
const [chatMessages, setChatMessages] = useState<any[]>([])
const [newMessage, setNewMessage] = useState('')
const chatEndRef = useRef<HTMLDivElement>(null)
```

### Ключевые функции
- `loadChatMessages()` - загрузка из localStorage
- `sendMessage()` - отправка и сохранение
- Auto-scroll effect - прокрутка при открытии вкладки

### Интеграция с вкладками
```typescript
const [activeTab, setActiveTab] = useState<'info' | 'tasks' | 'notes' | 'activity' | 'chat'>('info')
```

## Планы развития

### 🔄 TODO
1. **Backend API**
   - Создать endpoint `/api/deals/[id]/messages`
   - CRUD операции для сообщений
   - Привязка к сделке через deal_id

2. **Real-time обновления**
   - WebSocket подключение
   - Push-уведомления о новых сообщениях
   - Индикатор "печатает..."

3. **Расширенный функционал**
   - Прикрепление файлов
   - Упоминания (@mentions)
   - Редактирование сообщений
   - Удаление сообщений
   - Реакции (emoji)

4. **База данных**
   - Создать таблицу `deal_messages`
   - Схема:
     ```sql
     CREATE TABLE deal_messages (
       id UUID PRIMARY KEY,
       deal_id UUID REFERENCES deals(id),
       user_id UUID REFERENCES users(id),
       text TEXT NOT NULL,
       created_at TIMESTAMP DEFAULT NOW(),
       updated_at TIMESTAMP,
       is_read BOOLEAN DEFAULT false
     );
     ```

5. **UI улучшения**
   - Индикатор прочитанности (✓✓)
   - Группировка по дням
   - Поиск по сообщениям
   - Экспорт переписки

## Использование

### Открытие чата
1. Открыть любую сделку (клик по карточке на Kanban)
2. Перейти на вкладку "Переписка"
3. Начать общение

### Отправка сообщения
1. Ввести текст в поле внизу
2. Нажать `Enter` или кнопку ✉️
3. Сообщение появится справа синим цветом

### Демо
При первом открытии чата автоматически загружаются 2 демо-сообщения для демонстрации.

## Совместимость
- ✅ Next.js 15
- ✅ React 18+
- ✅ TypeScript
- ✅ Tailwind CSS
- ✅ Все современные браузеры

## Производительность
- Легкое хранилище (localStorage)
- Ленивая загрузка (только при открытии вкладки)
- Оптимизированный рендеринг (key на id сообщения)
- Плавная прокрутка (smooth scroll)
