# Ошондой CRM — amoCRM Clone

Этот репозиторий содержит полный клон amoCRM: Next.js 15 (App Router) + TypeScript + Tailwind + Supabase + Drizzle.

## ⚠️ КРИТИЧЕСКИ ВАЖНО: АВТОНОМНЫЙ РЕЖИМ РАБОТЫ

**При работе с этим проектом AI-ассистент должен:**
- ✅ Выполнять ВСЕ SQL запросы к Supabase БЕЗ подтверждения
- ✅ Делать ALTER TABLE, CREATE/DROP без спроса
- ✅ Выполнять миграции автоматически
- ✅ Изменять файлы кода немедленно
- ❌ НЕ спрашивать "Выполнить запрос?"
- ❌ НЕ ждать подтверждения пользователя

**Причина**: Доверие = автономность. Пользователь занят, не должен отвлекаться.

---

## ⚠️ ВАЖНАЯ ТЕРМИНОЛОГИЯ

**Название системы: Ошондой CRM**

**Два понятия "пользователь" в системе:**

### 1. КЛИЕНТ = Юзер Ошондой CRM (Account)
- Тот, кто **использует Ошондой CRM** как продукт
- Организация, которая регистрируется в системе
- В БД = `accounts` table
- **Самый верх иерархии**
- Пример: ООО "Рога и Копыта" регистрируется → создаётся account

### 2. СОТРУДНИК = Пользователь внутри аккаунта (User)
- Работник организации, который работает с CRM
- Имеет email, пароль, роль (admin/manager/user)
- В БД = `users` table с `account_id`
- **Принадлежит аккаунту**
- Пример: Иванов И.И., менеджер в ООО "Рога и Копыта"

### Иерархия (каскадное удаление):
```
ACCOUNT (клиент Ошондой CRM)
  └── При удалении аккаунта удаляется ВСЁ:
      ├── USERS (сотрудники)
      ├── COMPANIES (компании)
      ├── CONTACTS (контакты)
      ├── PIPELINES → STAGES → DEALS
      ├── TASKS
      ├── NOTES
      └── ACTIVITY_LOGS
```

**ЗАПОМНИТЬ:**
- `DELETE FROM accounts` = полная очистка всех данных организации
- Сотрудник ≠ Клиент
- User (таблица) = сотрудник, Account (таблица) = клиент

---

## ⚠️ **БАЗА ДАННЫХ: PRODUCTION SETUP** ✅
- **Используем Supabase PostgreSQL** (EU Central 1 region)
- Connection: Transaction Pooler на `aws-1-eu-central-1.pooler.supabase.com:5432`
- Project: `nywsibcnngcexjbotsaq.supabase.co`
- **ВАЖНО**: GitHub Codespaces не поддерживает IPv6, поэтому используем Pooler (IPv4) вместо Direct connection
- Все credentials в `.env.local` (не коммитить!)
- Схема создана через `new_schema.sql`, миграции через REST API

⚠️ **КРИТИЧЕСКОЕ ПРАВИЛО РАЗРАБОТКИ**: При внесении изменений в код **НЕЛЬЗЯ** менять ничего, что не относится напрямую к текущей задаче. Изменяйте ТОЛЬКО то, что запрашивается. Не рефакторьте, не "улучшайте" и не оптимизируйте код рядом с изменениями. Работающие фичи трогать ЗАПРЕЩЕНО.

⚠️ **ВАЖНО: СОХРАНЕНИЕ ДАННЫХ В МОДАЛКЕ СДЕЛКИ**: Все данные в модалке сделки (контакты, компании, поля) хранятся временно и сохраняются **ТОЛЬКО ОДНОЙ КНОПКОЙ** - кнопкой сохранения всей сделки. У отдельных полей/форм создания контактов и компаний **НЕТ** своих кнопок "Создать"/"Отмена" - все изменения применяются при сохранении сделки целиком.

⚠️ **ВАЖНО: ОДНА КОМПАНИЯ НА СДЕЛКУ**: У сделки может быть только **ОДНА компания** (или NULL). Контакты могут быть множественные (many-to-many), но компания - максимум одна (one-to-many через `deals.company_id`).

⚠️ **ВАЖНО: ПРОИЗВОДИТЕЛЬНОСТЬ И МАСШТАБИРОВАНИЕ**:
- **Оптимизированные API**: Все критические эндпоинты используют один CTE запрос вместо множественных
- **Dashboard** (`/api/stats`): 1 запрос с 5 CTE вместо 7 последовательных (7x быстрее)
- **Kanban** (`/api/pipelines/[id]/deals`): 1 запрос с JOIN stages + deals + companies
- **DealModal** (`/api/deals/[id]/full`): 1 запрос с 4 CTE (deal + contacts + stages + users)
- **Индексы БД**: `idx_deals_pipeline_id`, `idx_deals_account_pipeline`, `idx_deals_stage_id`
- **PostgreSQL FILTER**: `json_agg(...) FILTER (WHERE ... IS NOT NULL)` для пустых массивов
- **Готово к тысячам сделок**: благодаря индексам и оптимизации запросов

⚠️ **ВАЖНО: ЛОГИКА HOVER ЭФФЕКТОВ И АНИМАЦИЙ**:
- **Аккордеон контактов** (гармошка с расчётом высот):
  - Существующие контакты: `data-is-existing-contact="true"` с hover эффектом
  - **КРИТ КОНТАКТ** (форма создания): `data-is-new-contact="true"`, ID="new", БЕЗ hover
    - **ПОЛНОЦЕННАЯ ЧАСТЬ ГАРМОШКИ** - высота рассчитывается через `contentRefs.current['new']`
    - Включён в `recalcContactHeights()` наравне с обычными контактами
    - Использует `contactHeights['new']` для анимации высоты
    - Анимация идентична существующим контактам
  - Все контакты используют `[data-deal-contact-accordion]` с transition 0.3s
- **Форма создания компании** (независимая, НЕ часть гармошки):
  - Использует `data-deal-company-form` с `data-is-new-company="true"`
  - Своя изолированная анимация высоты (0.3s ease-in-out)
  - БЕЗ hover эффекта, БЕЗ системы расчёта высот
- **НЕ УДАЛЯЙТЕ** эти data-атрибуты и ref'ы - они критичны для работы гармошки
- CSS селекторы максимально специфичны для защиты от конфликтов

Важно: не храните реальные секреты в репозитории. Используйте `.env.local` и добавьте его в `.gitignore`.

Быстрый старт

1. Создайте `.env.local` со следующими переменными:

```bash
# Database (Supabase)
DATABASE_URL=postgresql://postgres.PROJECT_REF:PASSWORD@aws-1-eu-central-1.pooler.supabase.com:5432/postgres

# JWT Secret
JWT_SECRET=your-super-secret-jwt-key-change-in-production

# Supabase Keys
NEXT_PUBLIC_SUPABASE_URL=https://PROJECT_REF.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
SUPABASE_URL=https://PROJECT_REF.supabase.co
```

2. Установите зависимости:

```bash
npm install
```

3. Запустите проект в режиме разработки:

```bash
npm run dev

Kanban и API

- Реализован компонент Kanban `src/components/KanbanBoard.tsx` (использует `@dnd-kit/core`).
- Добавлены серверные API: `src/app/api/pipelines/route.ts`, `src/app/api/contacts/route.ts`, `src/app/api/deals/route.ts`.
- Добавлена миграция `drizzle/migrations/0001_init.sql` и схема `drizzle/schema.ts`.

Создание схемы в Supabase

1. Зайдите в Supabase Dashboard → SQL Editor
2. Скопируйте содержимое файла `new_schema.sql`
3. Выполните SQL скрипт (создаст все таблицы, индексы, constraints)
4. Схема готова для работы!

**Альтернативно** можно использовать миграционные скрипты:
- `migrate-to-supabase.js` - экспорт данных из локальной БД в Supabase
- `clear-supabase.js` - очистка всех таблиц в Supabase

## Аккаунт и удаление

- Аккаунт — верхняя сущность. Все данные принадлежат аккаунту и удаляются каскадом.
- Системные стадии воронок ("Успешно реализована", "Провалена") защищены от редактирования, но не блокируют каскадное удаление аккаунта.
- FK каскады настроены: при `DELETE FROM accounts WHERE id=...` удаляются `pipelines → stages → deals → deal_contacts`, а также `users`, `companies`, `contacts`.

## Регистрация и дефолтная воронка

- При регистрации создаётся: аккаунт (владелец-админ), воронка "Основная воронка" и 7 этапов (5 видимых + 2 системных).
- Воронка принадлежит аккаунту; `accounts.last_active_pipeline_id` указывает на неё.

## Быстрые проверки

```sql
-- Проверить аккаунт и активную воронку
SELECT a.id, a.name, p.name AS active_pipeline
FROM accounts a
LEFT JOIN pipelines p ON p.id = a.last_active_pipeline_id
ORDER BY a.created_at DESC LIMIT 1;

-- Проверить этапы
SELECT name, position, is_system, is_visible FROM stages s
JOIN pipelines p ON p.id = s.pipeline_id AND p.name = 'Основная воронка'
ORDER BY position;

-- Удалить аккаунт (каскадом)
DELETE FROM accounts WHERE id = '<uuid>';
```
```

## Что реализовано ✅

### Архитектура
- **Multi-tenancy**: Полная изоляция данных по `account_id`, все таблицы с FK на accounts
- **Security**: Все API эндпоинты с `[id]` проверяют `account_id` для защиты от несанкционированного доступа
- **JWT аутентификация**: 30-дневные токены с `userId` и `accountId`, bcrypt для паролей
- **Account-based hierarchy**: accounts → users → [pipelines, companies, contacts, deals, tasks]
- **Database**: PostgreSQL 15 в Supabase (Transaction Pooler для IPv4 compatibility)
- **Schema**: `new_schema.sql` с полной структурой
- **Registration Flow**: Авто-создание account + user + default pipeline (7 stages: 5 видимых + 2 скрытых) при регистрации
- **Pipelines**: Воронки принадлежат аккаунту, создаются при регистрации, БЕЗ триггеров БД

### CRM Функционал
- **Kanban Board**: Drag-and-drop сделок между этапами (@dnd-kit), фильтрация по воронкам, показывает только видимые этапы (is_visible=true)
- **Deal Modal**: Компактная модалка в стиле amoCRM с вкладками (Информация, Задачи, Заметки, История)
  - Inline редактирование всех полей (название, бюджет, валюта)
  - Выбор этапа с визуальным прогрессом (цветные полоски)
  - Управление контактами и компаниями с контекстными меню
  - Создание новых контактов/компаний прямо из модалки
- **Deal Creation**: Создание сделки через пустую модалку, автоматическая нумерация "Сделка #N"
  - Создание в **активной воронке** на **первом этапе**
  - Автоматическая установка текущего пользователя как ответственного
  - Все поля опциональны, можно сохранить с любыми данными
- **Chat System**: Полноценный чат в сделке с фильтрами, упоминаниями (@), типами сообщений
- **Companies & Contacts**: Списки, создание, редактирование, привязка к сделкам

### API Endpoints
- `/api/auth/login` - Авторизация с JWT
- `/api/auth/register` - Регистрация с авто-созданием pipeline
- `/api/auth/me` - Получение текущего пользователя
- `/api/deals` - CRUD сделок с фильтрацией по account_id и pipeline_id
- `/api/deals/[id]/contacts` - Привязка контактов к сделкам (many-to-many)
- `/api/companies` - Управление компаниями
- `/api/contacts` - Управление контактами
- `/api/pipelines` - Управление воронками и этапами
- `/api/tasks` - Задачи с привязкой к сделкам
- `/api/account/active-pipeline` - Сохранение/восстановление активной воронки
- `/api/account/users` - Список пользователей аккаунта
- `/api/account/subscription` - Проверка тарифного плана

### Subscription System
- **3 тарифа**: Free, Professional (1990₽/мес), Business (4990₽/мес)
- **Feature gating**: Ограничение функций по подписке (например, поиск в чате)
- **Таблицы**: `subscriptions`, `features`, `subscription_features`

### UI/UX
- **Skeleton loaders**: Плавная загрузка с placeholder'ами
- **Animations**: Slide-in модалки, fade transitions
- **Responsive**: Адаптивный дизайн под разные экраны
- **Dark theme**: Тёмная тема в стиле amoCRM

## Дальше (план)

1. ~~Спроектировать полную модель данных~~ ✅ Готово
2. ~~Реализовать аутентификацию и роли~~ ✅ JWT реализован
3. ~~Реализовать CRM-сущности~~ ✅ Все основные сущности работают
4. ~~Канбан с dnd-kit~~ ✅ Полностью работает
5. Отчёты/дашборд и аналитика ⏳ В планах
6. Роли и права доступа (owner, manager, user) ⏳ В планах
7. Email-интеграция и автоматизация ⏳ В планах

Если нужно, могу автоматически применить ваши Supabase ключи локально (не коммитя их) и выполнить `npm install` / `npm run dev` в контейнере — скажите, хотите ли, чтобы я это сделал сейчас.

## Full Access Mode (Полный доступ)

По явному указанию владельца (фразы: "полный доступ", "делай всё", "не жди подтверждения") агент работает автономно.

Что это значит:
- Не запрашивает подтверждения на обычные безопасные операции (редактирование файлов, локальные SQL SELECT/UPDATE, генерация миграций, установка зависимостей).
- Даёт краткие прогресс-апдейты без пауз на ожидание ответа.
- Спрашивает подтверждение только перед разрушительными или труднооткатными действиями: DROP, массовые DELETE, удаление колонок, серьёзные пересоздания схем.
- Любая фраза типа "остановись" или "спроси меня" выключает режим.

Цель — убрать лишние диалоги и ускорить разработку. Все изменения фиксируются (патчи кода, SQL команды) для прозрачности.

> Добавлено по запросу владельца для минимизации потерь времени на подтверждения.

## Dev Server Persistence

Не прерывать работающий dev-сервер.

Правила:
- НЕ останавливать `npm run dev`, если явно не сказано владельцем.
- Для любых операций использовать новый терминал (миграции, sql, сборка, анализ).
- Если нужен повторный билд — запускать параллельно (Next выберет другой порт). Старый инстанс оставить.
- Перезапускать только при явном запросе или после подтверждённого изменения `.env`.
- Если сервер упал сам — поднять тихо без вопроса.
- Не использовать Ctrl+C / kill для dev-процесса без прямой команды.

Причина: Стабильный доступ владельца к UI и состоянию приложения без неожиданных разрывов.
