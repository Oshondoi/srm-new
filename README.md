# srm-new — amoCRM-like platform (skeleton)

Этот репозиторий содержит стартовый скелет для клона amoCRM: Next.js 15 (App Router) + TypeScript + Tailwind + Supabase + Drizzle.

Важно: не храните реальные секреты в репозитории. Используйте `.env.local` и добавьте его в `.gitignore`.

Быстрый старт

1. Скопируйте `.env.example` в `.env.local` и заполните переменные (SUPABASE ключи, DATABASE_URL).
2. Установите зависимости:

```bash
npm install
```

3. Запустите проект в режиме разработки:

```bash
npm run dev

Kanban и API

- Реализован компонент Kanban `src/components/KanbanBoard.tsx` (использует `@dnd-kit/core`).
- Добавлены серверные API: `src/app/api/pipelines/route.ts`, `src/app/api/contacts/route.ts`, `src/app/api/deals/route.ts`.
- Добавлена миграция `drizzle/migrations/0001_init.sql` и схема `drizzle/schema.ts`.

Запуск миграций

1. Заполните `DATABASE_URL` в `.env.local`.
2. Используйте `drizzle-kit` (установлен в devDependencies) для создания/применения миграций:

```bash
npx drizzle-kit generate --out ./drizzle/migrations
npx drizzle-kit push
```

Будьте осторожны: операция `push` изменит вашу базу данных.
```

## Что реализовано ✅

### Архитектура
- **Multi-tenancy**: Полная изоляция данных по `account_id`, все таблицы с FK на accounts
- **JWT аутентификация**: 30-дневные токены с `userId` и `accountId`, bcrypt для паролей
- **Account-based hierarchy**: accounts → users → [pipelines, companies, contacts, deals, tasks]
- **Database**: PostgreSQL 16 в Docker контейнере
- **Schema**: `new_schema.sql` с полной структурой, triggers для авто-создания pipeline

### CRM Функционал
- **Kanban Board**: Drag-and-drop сделок между этапами (@dnd-kit), фильтрация по воронкам
- **Deal Modal**: Компактная модалка в стиле amoCRM с вкладками (Информация, Задачи, Заметки, История)
  - Inline редактирование всех полей (название, бюджет, валюта)
  - Выбор этапа с визуальным прогрессом (цветные полоски)
  - Управление контактами и компаниями с контекстными меню
  - Создание новых контактов/компаний прямо из модалки
- **Deal Creation**: Создание сделки через пустую модалку, автоматическая нумерация "Сделка #N"
  - Создание в **активной воронке** на **первом этапе**
  - Автоматическая установка текущего пользователя как ответственного
  - Все поля опциональны, можно сохранить с любыми данными
- **Chat System**: Полноценный чат в сделке с фильтрами, упоминаниями (@), типами сообщений
- **Companies & Contacts**: Списки, создание, редактирование, привязка к сделкам

### API Endpoints
- `/api/auth/login` - Авторизация с JWT
- `/api/auth/register` - Регистрация с авто-созданием pipeline
- `/api/auth/me` - Получение текущего пользователя
- `/api/deals` - CRUD сделок с фильтрацией по account_id и pipeline_id
- `/api/deals/[id]/contacts` - Привязка контактов к сделкам (many-to-many)
- `/api/companies` - Управление компаниями
- `/api/contacts` - Управление контактами
- `/api/pipelines` - Управление воронками и этапами
- `/api/tasks` - Задачи с привязкой к сделкам
- `/api/account/active-pipeline` - Сохранение/восстановление активной воронки
- `/api/account/users` - Список пользователей аккаунта
- `/api/account/subscription` - Проверка тарифного плана

### Subscription System
- **3 тарифа**: Free, Professional (1990₽/мес), Business (4990₽/мес)
- **Feature gating**: Ограничение функций по подписке (например, поиск в чате)
- **Таблицы**: `subscriptions`, `features`, `subscription_features`

### UI/UX
- **Skeleton loaders**: Плавная загрузка с placeholder'ами
- **Animations**: Slide-in модалки, fade transitions
- **Responsive**: Адаптивный дизайн под разные экраны
- **Dark theme**: Тёмная тема в стиле amoCRM

## Дальше (план)

1. ~~Спроектировать полную модель данных~~ ✅ Готово
2. ~~Реализовать аутентификацию и роли~~ ✅ JWT реализован
3. ~~Реализовать CRM-сущности~~ ✅ Все основные сущности работают
4. ~~Канбан с dnd-kit~~ ✅ Полностью работает
5. Отчёты/дашборд и аналитика ⏳ В планах
6. Роли и права доступа (owner, manager, user) ⏳ В планах
7. Email-интеграция и автоматизация ⏳ В планах

Если нужно, могу автоматически применить ваши Supabase ключи локально (не коммитя их) и выполнить `npm install` / `npm run dev` в контейнере — скажите, хотите ли, чтобы я это сделал сейчас.

## Full Access Mode (Полный доступ)

По явному указанию владельца (фразы: "полный доступ", "делай всё", "не жди подтверждения") агент работает автономно.

Что это значит:
- Не запрашивает подтверждения на обычные безопасные операции (редактирование файлов, локальные SQL SELECT/UPDATE, генерация миграций, установка зависимостей).
- Даёт краткие прогресс-апдейты без пауз на ожидание ответа.
- Спрашивает подтверждение только перед разрушительными или труднооткатными действиями: DROP, массовые DELETE, удаление колонок, серьёзные пересоздания схем.
- Любая фраза типа "остановись" или "спроси меня" выключает режим.

Цель — убрать лишние диалоги и ускорить разработку. Все изменения фиксируются (патчи кода, SQL команды) для прозрачности.

> Добавлено по запросу владельца для минимизации потерь времени на подтверждения.

## Dev Server Persistence

Не прерывать работающий dev-сервер.

Правила:
- НЕ останавливать `npm run dev`, если явно не сказано владельцем.
- Для любых операций использовать новый терминал (миграции, sql, сборка, анализ).
- Если нужен повторный билд — запускать параллельно (Next выберет другой порт). Старый инстанс оставить.
- Перезапускать только при явном запросе или после подтверждённого изменения `.env`.
- Если сервер упал сам — поднять тихо без вопроса.
- Не использовать Ctrl+C / kill для dev-процесса без прямой команды.

Причина: Стабильный доступ владельца к UI и состоянию приложения без неожиданных разрывов.
