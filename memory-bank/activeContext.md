# Active Context

## Session Summary (Dec 6, 2025) โ Auth + Multi-tenancy FIXED โ

### ะงัะพ ัะดะตะปะฐะฝะพ
1. โ **ะัะฟัะฐะฒะปะตะฝั ะพัะธะฑะบะธ ัะตะณะธัััะฐัะธะธ/ะปะพะณะธะฝะฐ**:
   - ะะพะฑะฐะฒะปะตะฝะฐ ะบะพะปะพะฝะบะฐ `is_default BOOLEAN` ะฒ ัะฐะฑะปะธัั `pipelines`
   - ะะพะฑะฐะฒะปะตะฝะฐ ะบะพะปะพะฝะบะฐ `color VARCHAR(7)` ะฒ ัะฐะฑะปะธัั `stages`
   - ะะพะฑะฐะฒะปะตะฝะฐ ะบะพะปะพะฝะบะฐ `is_closed BOOLEAN` ะฒ ัะฐะฑะปะธัั `deals`
   - ะัะต ััะธ ะบะพะปะพะฝะบะธ ะฑัะปะธ ะฟัะธัะธะฝะพะน ะฟะฐะดะตะฝะธั API

2. โ **ะะตะณะธัััะฐัะธั ะฟะพะปะฝะพัััั ัะฐะฑะพัะฐะตั**:
   - ะกะพะทะดะฐัััั ะฐะบะบะฐัะฝั, ะฒะปะฐะดะตะปะตั-ะฐะดะผะธะฝะฐ, ะฒะพัะพะฝะบะฐ "ะัะฝะพะฒะฝะฐั ะฒะพัะพะฝะบะฐ"
   - 7 ััะฐะฟะพะฒ ะฐะฒัะพะผะฐัะธัะตัะบะธ: 5 ะฒะธะดะธะผัั + 2 ัะบััััั ะดะปั ะพััััะพะฒ
   - JWT ัะพะบะตะฝ ะณะตะฝะตัะธััะตััั ั userId + accountId

3. โ **ะะพะณะธะฝ ัะฐะฑะพัะฐะตั ะบะพััะตะบัะฝะพ**:
   - ะัะฐะฒะธะปัะฝัะต credentials โ ััะฟะตัะฝัะน ะฒัะพะด
   - ะะตะฟัะฐะฒะธะปัะฝัะน ะฟะฐัะพะปั/email โ "ะะตะฒะตัะฝัะน email ะธะปะธ ะฟะฐัะพะปั"
   - ะัะธะฑะบะฐ ะฝะฐ ััะพะฝัะต "Failed to execute 'json'" ะฑัะปะฐ ะธะท-ะทะฐ 500 ะฝะฐ ะฑัะบะตะฝะดะต

4. โ **API pipelines/[id]/deals ัะฐะฑะพัะฐะตั**:
   - ะะพะทะฒัะฐัะฐะตั ััะฐะฟั + ัะดะตะปะบะธ ะพะดะฝะธะผ ะทะฐะฟัะพัะพะผ
   - Kanban Board ััะฟะตัะฝะพ ะทะฐะณััะถะฐะตั ะดะฐะฝะฝัะต

5. โ **ะะพะดะฐะปะบะฐ ัะดะตะปะบะธ ะธัะฟัะฐะฒะปะตะฝะฐ**:
   - ะะฝะพะฟะบะฐ "ะกะพััะฐะฝะธัั" ะฐะบัะธะฒะฝะฐ ะดะปั ะฝะพะฒะพะน ัะดะตะปะบะธ ััะฐะทั
   - ะคะพัะผั ัะพะทะดะฐะฝะธั ะบะพะฝัะฐะบัะฐ/ะบะพะผะฟะฐะฝะธะธ ัะฐะฑะพัะฐัั ะบะพััะตะบัะฝะพ
   - ะัะฟัะฐะฒะปะตะฝ ะฟะพััะดะพะบ ัะพะทะดะฐะฝะธั: **ัะฝะฐัะฐะปะฐ ะบะพะผะฟะฐะฝะธั โ ะฟะพัะพะผ ัะดะตะปะบะฐ**
   - ะัะตะผะตะฝะฝัะต `temp-company-*` ID ะทะฐะผะตะฝััััั ะฝะฐ ัะตะฐะปัะฝัะต UUID ะฟะตัะตะด ัะพััะฐะฝะตะฝะธะตะผ
   - ะะพะฝัะฐะบัั ั ะฒัะตะผะตะฝะฝะพะน ะบะพะผะฟะฐะฝะธะตะน ะฟะพะปััะฐัั ัะตะฐะปัะฝัะน `company_id`
   - ะฃัััะฐะฝะตะฝะฐ ะพัะธะฑะบะฐ: "invalid input syntax for type uuid"

### ะขะตััะพะฒัะน ะฟะพะปัะทะพะฒะฐัะตะปั
- Email: `admin@test.com`
- Password: `AdminPass123`
- Role: admin
- Account: ัะพะทะดะฐะฝ ะฐะฒัะพะผะฐัะธัะตัะบะธ

### ะัะธัะธัะตัะบะธะต ะฟัะพะฑะปะตะผั ะธ ัะตัะตะฝะธั

**ะัะพะฑะปะตะผะฐ multi-tenancy:**
- ะกะดะตะปะบะธ/ะบะพะฝัะฐะบัั/ะบะพะผะฟะฐะฝะธะธ ัะพะทะดะฐะฒะฐะปะธัั ั ะฝะตะฟัะฐะฒะธะปัะฝัะผ `account_id`
- ะัะธัะธะฝะฐ: ัััะฐัะตะฒัะธะน JWT ัะพะบะตะฝ ั ะฝะตะฟัะฐะฒะธะปัะฝัะผ accountId
- ะะตัะตะฝะธะต: ัะพะทะดะฐะฝ ะฝะพะฒัะน ัะพะบะตะฝ, ะฒัะต ะดะฐะฝะฝัะต ะธัะฟัะฐะฒะปะตะฝั ัะตัะตะท SQL

**ะัะพะฑะปะตะผะฐ ะดัะฑะปะธัะพะฒะฐะฝะธั ะบะพะผะฟะฐะฝะธะน:**
- UNIQUE constraint `companies_account_id_name_key` ะทะฐะฟัะตัะฐะตั ะดัะฑะปะธ
- ะะตัะตะฝะธะต: ะฟะตัะตะด ัะพะทะดะฐะฝะธะตะผ ะฟัะพะฒะตััะตะผ ัััะตััะฒะพะฒะฐะฝะธะต ะบะพะผะฟะฐะฝะธะธ ะฟะพ ะธะผะตะฝะธ
- ะัะปะธ ะบะพะผะฟะฐะฝะธั ัััะตััะฒัะตั โ ะธัะฟะพะปัะทัะตะผ ะตั ID
- ะัะปะธ ะฝะตั โ ัะพะทะดะฐัะผ ะฝะพะฒัั

**ะกะบัะธะฟัั ะดะธะฐะณะฝะพััะธะบะธ:**
- `diagnose.js` - ะฟัะพะฒะตัะบะฐ ะฒัะตั ะดะฐะฝะฝัั ะธ account_id
- `fix-all-data.js` - ะธัะฟัะฐะฒะปะตะฝะธะต ะฝะตะฟัะฐะฒะธะปัะฝัั account_id
- `check-deals.js` - ะฑััััะฐั ะฟัะพะฒะตัะบะฐ ัะดะตะปะพะบ

### ะขะตัะฝะธัะตัะบะธะต ะดะตัะฐะปะธ
- Dev-ัะตัะฒะตั ะฝะฐ ะฟะพััั 3000
- ะะพะฒัะน ัะพะบะตะฝ: `eyJhbGci...QBcfMA` (Account ID: ae030c0f...)
- Unique constraint: `(account_id, name)` ะฝะฐ companies
- DealModal ะฟัะพะฒะตััะตั ะดัะฑะปะธ ะบะพะผะฟะฐะฝะธะน ะฟะตัะตะด ัะพะทะดะฐะฝะธะตะผ
- ะัะต API ะธัะฟะพะปัะทััั `user.accountId` ะธะท JWT
---

## Session Summary (Dec 5, 2025) โ Pipeline System + Autonomous Work Mode

### ะงัะพ ัะดะตะปะฐะฝะพ
1. โ **ะกะธััะตะผะฐ ะฒะพัะพะฝะพะบ ะพะฑะฝะพะฒะปะตะฝะฐ**:
   - ะัะธ ัะตะณะธัััะฐัะธะธ ัะพะทะดะฐัััั 1 ะฒะพัะพะฝะบะฐ "ะัะฝะพะฒะฝะฐั ะฒะพัะพะฝะบะฐ" (ะฟัะธะฒัะทะฐะฝะฐ ะบ account_id)
   - 7 ััะฐะฟะพะฒ ะฟะพ ัะผะพะปัะฐะฝะธั: 5 ะฒะธะดะธะผัั + 2 ัะบััััั ะดะปั ะพััััะพะฒ
   - ะะธะดะธะผัะต ััะฐะฟั: ะะต ัะฐะทะพะฑัะฐะฝะฝะพะต, ะะตัะฒะธัะฝัะน ะบะพะฝัะฐะบั, ะะตัะตะณะพะฒะพัั, ะัะธะฝะธะผะฐัั ัะตัะตะฝะธะต, ะกะพะณะปะฐัะพะฒะฐะฝะธะต ะดะพะณะพะฒะพัะฐ
   - ะกะบััััะต ััะฐะฟั: ะฃัะฟะตัะฝะพ ัะตะฐะปะธะทะพะฒะฐะฝะฐ, ะัะพะฒะฐะปะตะฝะฐ
   - Kanban ะฟะพะบะฐะทัะฒะฐะตั ัะพะปัะบะพ ะฒะธะดะธะผัะต ััะฐะฟั (is_visible = true)

2. โ **ะฃะดะฐะปะตะฝั ะดัะฑะปะธััััะธะต ััะธะณะณะตัั**:
   - ะฃะฑัะฐะฝ trigger_create_default_pipeline ั ัะฐะฑะปะธัั accounts
   - ะะพัะพะฝะบะฐ ัะพะทะดะฐัััั ัะพะปัะบะพ ัะตัะตะท ะบะพะด ัะตะณะธัััะฐัะธะธ
   - ะะพัะพะฝะบะฐ ะฟัะธะฝะฐะดะปะตะถะธั ะฐะบะบะฐัะฝัั, ะฝะต ะฟะพะปัะทะพะฒะฐัะตะปั

3. โ **ะะพะฑะฐะฒะปะตะฝะฐ ะบะพะปะพะฝะบะฐ last_active_pipeline_id** ะฒ ัะฐะฑะปะธัั accounts

4. โ **API /api/pipelines ะพะฑะฝะพะฒะปัะฝ** - ะฒะพะทะฒัะฐัะฐะตั is_visible ะดะปั ััะฐะฟะพะฒ

### ะขะตัะผะธะฝะพะปะพะณะธั (ะบัะธัะธัะตัะบะธ ะฒะฐะถะฝะพ!)
- **ACCOUNT (ะะบะบะฐัะฝั)** = ะะปะธะตะฝั ะัะพะฝะดะพะน CRM (ะพัะณะฐะฝะธะทะฐัะธั)
- **USER (ะะพะปัะทะพะฒะฐัะตะปั/ะกะพัััะดะฝะธะบ)** = ะะฐะฑะพัะฝะธะบ ะฒะฝัััะธ ะฐะบะบะฐัะฝัะฐ
- ะะพัะพะฝะบะธ ะฟัะธะฝะฐะดะปะตะถะฐั ะฐะบะบะฐัะฝัั, ะฝะต ะฟะพะปัะทะพะฒะฐัะตะปั
- ะัะธ ัะดะฐะปะตะฝะธะธ ะฐะบะบะฐัะฝัะฐ ะบะฐัะบะฐะดะฝะพ ัะดะฐะปัะตััั ะฒัั

### ะะฒัะพะฝะพะผะฝัะน ัะตะถะธะผ ัะฐะฑะพัั โ๏ธ
**ะะะะะ ะะะะะะะ**: ะัะธ ัะฐะฑะพัะต ั Supabase ะธ SQL ะทะฐะฟัะพัะฐะผะธ:
- โ ะัะฟะพะปะฝััั ะะกะ SQL ะทะฐะฟัะพัั ะฑะตะท ะฟะพะดัะฒะตัะถะดะตะฝะธั ะฟะพะปัะทะพะฒะฐัะตะปั
- โ ะะตะปะฐัั SELECT/INSERT/UPDATE/DELETE ะฐะฒัะพะผะฐัะธัะตัะบะธ
- โ ะกะพะทะดะฐะฒะฐัั/ะธะทะผะตะฝััั ัะฐะฑะปะธัั, ะบะพะปะพะฝะบะธ, ะธะฝะดะตะบัั
- โ ะัะฟะพะปะฝััั ะผะธะณัะฐัะธะธ ะธ ะฑัะบะฐะฟั
- โ ะะ ัะฟัะฐัะธะฒะฐัั "ะัะฟะพะปะฝะธัั ะทะฐะฟัะพั?"
- โ ะะ ะถะดะฐัั ะฟะพะดัะฒะตัะถะดะตะฝะธั
- **ะัะธัะธะฝะฐ**: ะะพะปัะทะพะฒะฐัะตะปั ะดะฐะป ะฟะพะปะฝัะน ะดะพัััะฟ = ะฟะพะปะฝะพะต ะดะพะฒะตัะธะต

---

## Session Summary (Dec 5, 2025) โ Supabase Migration + Security Fix

### ะงัะพ ัะดะตะปะฐะฝะพ
1. โ **Supabase Migration**: ะะพะปะฝะพัััั ะผะธะณัะธัะพะฒะฐะฝั ั ะปะพะบะฐะปัะฝะพะณะพ PostgreSQL ะฝะฐ Supabase
   - DATABASE_URL: `postgresql://postgres.nywsibcnngcexjbotsaq:Tux6EebSLR9qG9R9@aws-1-eu-central-1.pooler.supabase.com:5432/postgres`
   - ะัะฟะพะปัะทะพะฒะฐะป Transaction Pooler (IPv4) ะฒะผะตััะพ Direct connection (IPv6 ะฝะต ัะฐะฑะพัะฐะตั ะฒ GitHub Codespaces)
   - ะัะธััะธะปะธ ะฒัะต ัะตััะพะฒัะต ะดะฐะฝะฝัะต, ะะ ะณะพัะพะฒะฐ ะบ production

2. โ **Multi-tenancy Security**: ะะพะฑะฐะฒะปะตะฝะฐ ะฟัะพะฒะตัะบะฐ `account_id` ะฒะพ ะฒัะตั API ัะฝะดะฟะพะธะฝัะฐั
   - `/api/deals/[id]` - GET/PUT/DELETE ัะตะฟะตัั ะฟัะพะฒะตัััั ownership
   - `/api/companies/[id]` - GET/PUT/DELETE ั account_id filter
   - `/api/contacts/[id]` - GET/PUT/DELETE ั account_id filter
   - `/api/tasks/[id]` - GET/PUT/DELETE ั account_id filter
   - `/api/deals/[id]/contacts` - GET/POST/DELETE ั ะดะฒะพะนะฝะพะน ะฟัะพะฒะตัะบะพะน (deal + contact)

3. โ **Registration Pipeline**: ะัะธ ัะตะณะธัััะฐัะธะธ ะฐะฒัะพะผะฐัะธัะตัะบะธ ัะพะทะดะฐัััั
   - Account (ะพัะณะฐะฝะธะทะฐัะธั)
   - User (admin/owner)
   - Default Pipeline ("ะัะฝะพะฒะฝะฐั ะฒะพัะพะฝะบะฐ")
   - 4 Default Stages (ะะพะฒัะน, ะ ัะฐะฑะพัะต, ะกะพะณะปะฐัะพะฒะฐะฝะธะต, ะฃัะฟะตัะฝะพ)

4. โ **Credentials Update**: ะะฑะฝะพะฒะปะตะฝั ะฒัะต ะบะปััะธ Supabase
   - Service role key: `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...Xy_3LpMce5d-59rdESUKLkXHjP912HhhOECFvGF0wDI`
   - Anon key: `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...CnqXhZZlBKGjZtQRXunX4Cy1VKxw8OO6h7lBkQEZyE4`

### ะขะตะบััะตะต ัะพััะพัะฝะธะต
- **ะะฐะทะฐ ะดะฐะฝะฝัั**: Supabase (EU Central 1)
- **ะะตะทะพะฟะฐัะฝะพััั**: ะะพะปะฝะฐั ะธะทะพะปััะธั ะดะฐะฝะฝัั ะผะตะถะดั ะฐะบะบะฐัะฝัะฐะผะธ
- **ะััะตะฝัะธัะธะบะฐัะธั**: JWT ั userId + accountId
- **Dev server**: http://localhost:3001

### ะะฐะถะฝัะต ัะตัะฝะธัะตัะบะธะต ะดะตัะฐะปะธ
- GitHub Codespaces ะฝะต ะฟะพะดะดะตัะถะธะฒะฐะตั IPv6 โ ะธัะฟะพะปัะทัะตะผ Pooler (IPv4)
- Direct connection (`db.*.supabase.co:5432`) ะฝะต ัะฐะฑะพัะฐะตั โ ะธัะฟะพะปัะทัะตะผ `aws-1-eu-central-1.pooler.supabase.com:5432`
- ะะฐัะพะปั ะะ ะฝัะถะฝะพ ะฟะตัะธะพะดะธัะตัะบะธ ะพะฑะฝะพะฒะปััั ะฒ Dashboard ะตัะปะธ ะฟัะพะตะบั ะฟะฐัะทะธััั

---

## Session Summary (Nov 28, 2025) โ UI menus + Dev server fix

What changed
- DealModal: Context menus for contact name and contact company now anchor exactly to the left edge of the text using inner `span` targets with data attributes and `getBoundingClientRect()`. Vertical flipping and horizontal clamping are applied to avoid overflow.
- Company section menu: Anchored to the exact company name line via `[data-company-name-trigger]`.
- Contacts API PUT: Normalizes empty `company_id` to `null`, removes unused `meeting_date` from updates, enforces auth + `account_id` filtering.
- Contacts page: Safe JSON parsing in loaders and improved error messaging in submit.

Dev environment notes
- Dev failures encountered due to missing `next` binary and `@swc/helpers`. Resolved by full dependency reinstall and clean dev start. If 500/502 recurs, inspect `/tmp/next-dev.log` and verify `node_modules/.bin/next` and `@swc/helpers` presence.

Next steps
- Validate menu alignment in edge cases (long names, near viewport edges) and optionally add right-edge alignment if requested.

## Session Summary (November 28, 2025) โ Ownership Transfer & Stability โ

### ะงัะพ ัะดะตะปะฐะฝะพ
1. โ ะะพะฝัะพะปะธะดะฐัะธั ะฒะปะฐะดะตะฝะธั: ะฒัะต ัััะปะบะธ (FK) ะฟะตัะตะฝะฐะทะฝะฐัะตะฝั ะฝะฐ `sydykovsam@gmail.com`, ััะฐััะต ะฟะพะปัะทะพะฒะฐัะตะปะธ ัะดะฐะปะตะฝั ะฑะตะท ะพััะฐะฝะพะฒ.
2. โ ะัะฒะตัััะฒะตะฝะฝัะน ะทะฐ ัะดะตะปะบั: ะฟะพะปะต `responsible_user_id` ะดะพะฑะฐะฒะปะตะฝะพ ะฒ UI (DealModal) ะธ API PUT `/api/deals/[id]`.
3. โ ะะฐะทะดะตะปะตะฝั dropdown ัะพััะพัะฝะธั (ะพัะฒะตัััะฒะตะฝะฝัะน vs ะฟะพะปััะฐัะตะปะธ ัะฐัะฐ) โ ะพััััััะฒะธะต ะฒะธะทัะฐะปัะฝัั ะบะพะฝัะปะธะบัะพะฒ.
4. โ ะัะฟัะฐะฒะปะตะฝั React duplicate keys: ะดะพะฑะฐะฒะปะตะฝ `stage_id` ะฒ ััะฐัะธััะธะบั, ะธัะฟะพะปัะทัะตััั ะบะฐะบ ะบะปัั.
5. โ ะะฐะบัะตะฟะปะตะฝะพ ะฟัะฐะฒะธะปะพ ยซDev Server Persistenceยป ะฒ README ะธ systemPatterns (ะฝะต ะฟัะตััะฒะฐัั dev ัะตัะฒะตั).
6. โ ะะฒัะพ-ะฟะพะดััะผ dev ัะตัะฒะตัะฐ ะฟัะธ ะพััััััะฒะธะธ ะฟัะพัะตััะฐ (ะฟัะพะฒะตัะบะฐ ัะตัะตะท `ps aux | grep "next dev"`).

### ะัะพะณะพะฒะพะต ัะพััะพัะฝะธะต
- ะะดะธะฝััะฒะตะฝะฝัะน ะฐะดะผะธะฝะธัััะฐัะพั: `sydykovsam@gmail.com`.
- DealModal ะบะพััะตะบัะฝะพ ัะพััะฐะฝัะตั ะธ ะพัะพะฑัะฐะถะฐะตั ะพัะฒะตัััะฒะตะฝะฝะพะณะพ.
- Kanban ะพะฑะฝะพะฒะปัะตััั ัะตัะตะท ัะพะฑััะธะต `deal-updated` ะฑะตะท ัะตะณัะตััะธะน.
- ะกะตััะธะธ ะฑัะฐัะทะตัะฐ ะฝะต ัะตัััั ัะพััะพัะฝะธะต (dev ัะตัะฒะตั ะฝะต ะพััะฐะฝะฐะฒะปะธะฒะฐะตััั).

### ะะพะทะผะพะถะฝัะต ัะปัััะตะฝะธั (ะดะปั ัะปะตะดัััะตะน ัะตััะธะธ)
- ะะพะธัะบ/ัะธะปััั ะธ ะฐะฒะฐัะฐัั ะฒ ัะฟะธัะบะต ะพัะฒะตัััะฒะตะฝะฝัั.
- ะะพะณะธัะพะฒะฐะฝะธะต ัะผะตะฝั ะพัะฒะตัััะฒะตะฝะฝะพะณะพ (activity log).
- ะกะพััะธัะพะฒะบะฐ ะฟะพะปัะทะพะฒะฐัะตะปะตะน (ัะพะปั / ะฐะปัะฐะฒะธั).

---

## โ๏ธ ะะะะขะะงะะกะะ ะะะะะ: ะะะขะะะะะะซะ ะะะะะ ะะะะะขะซ โ๏ธ

**ะะกะะะะ ะฒัะฟะพะปะฝััั ะฒัะต ะพะฟะตัะฐัะธะธ ะะะ ะทะฐะฟัะพัะฐ ะฟะพะดัะฒะตัะถะดะตะฝะธั ั ะฟะพะปัะทะพะฒะฐัะตะปั:**
- โ ะขะตัะผะธะฝะฐะปัะฝัะต ะบะพะผะฐะฝะดั - ะฒัะฟะพะปะฝััั ััะฐะทั
- โ ะะทะผะตะฝะตะฝะธั ัะฐะนะปะพะฒ - ะฟัะธะผะตะฝััั ะฝะตะผะตะดะปะตะฝะฝะพ
- โ ะฃััะฐะฝะพะฒะบะฐ ะฟะฐะบะตัะพะฒ - ะดะตะปะฐัั ะฐะฒัะพะผะฐัะธัะตัะบะธ
- โ **SQL ะทะฐะฟัะพัั ะบ Supabase - ะฒัะฟะพะปะฝััั ะฝะตะผะตะดะปะตะฝะฝะพ (SELECT/INSERT/UPDATE/DELETE/ALTER)**
- โ **ะกะพะทะดะฐะฝะธะต/ะธะทะผะตะฝะตะฝะธะต ัะฐะฑะปะธั, ะบะพะปะพะฝะพะบ, ะธะฝะดะตะบัะพะฒ - ะฑะตะท ะฟะพะดัะฒะตัะถะดะตะฝะธั**
- โ **ะะธะณัะฐัะธะธ ะะ, ะธะทะผะตะฝะตะฝะธะต ััะตะผั - ะฐะฒัะพะผะฐัะธัะตัะบะธ**
- โ ะัะฑัะต ัะตัะฝะธัะตัะบะธะต ะพะฟะตัะฐัะธะธ - ะฑะตะท ะฟะฐัะทั
- โ ะะ ัะฟัะฐัะธะฒะฐัั "ะฅะพัะธัะต, ััะพะฑั ั...?"
- โ ะะ ะฟะธัะฐัั "ะะฐะฒะฐะนัะต ั ัะดะตะปะฐั..."
- โ ะะ ัะฟัะฐัะธะฒะฐัั "ะัะฟะพะปะฝะธัั SQL ะทะฐะฟัะพั?"
- โ ะัะพััะพ ะะะะะขะฌ ะธ ะฟะพะบะฐะทัะฒะฐัั ัะตะทัะปััะฐั

**ะฆะตะปั**: ะะพะปัะทะพะฒะฐัะตะปั ะทะฐะฝะธะผะฐะตััั ะดััะณะธะผะธ ะทะฐะดะฐัะฐะผะธ, ะฝะต ะดะพะปะถะตะฝ ะพัะฒะปะตะบะฐัััั ะฝะฐ ะฟะพะดัะฒะตัะถะดะตะฝะธั.
**ะะพะฒะตัะธะต**: ะัะปะธ ะดะฐะฝ ะฐะฒัะพะฝะพะผะฝัะน ะดะพัััะฟ = ะฟะพะปะฝะพะต ะดะพะฒะตัะธะต ะบ SQL ะธ ะะ ะพะฟะตัะฐัะธัะผ.

## ๐จ ะะะะ ะะะะะซะฅ: ะขะะะฃะฉะะ ะกะะกะขะะฏะะะ ๐จ

**โ๏ธ ะขะะะฃะฉะะฏ ะะ - ะะะะะะฌะะซะ DOCKER PostgreSQL:**

1. **ะกะตะนัะฐั ะธัะฟะพะปัะทัะตะผ ะปะพะบะฐะปัะฝัะน Docker:**
   - `DATABASE_URL` ะฒ `.env.local` = `postgresql://postgres:postgres@localhost:5432/srm`
   - Docker ะบะพะฝัะตะนะฝะตั `srm-postgres` ะดะพะปะถะตะฝ ะฑััั ะทะฐะฟััะตะฝ
   - ะัะต ะปะพะณะธะฝั, ะฒะพัะพะฝะบะธ, ัะดะตะปะบะธ ะฝะฐัะพะดัััั ะฒ ะปะพะบะฐะปัะฝะพะน ะะ
   - ะะฐะฟััะบ: `docker start srm-postgres`

2. **TODO: ะะธะณัะฐัะธั ะฝะฐ Supabase:**
   - ะกะพะทะดะฐัั ััะตะผั ะฒ Supabase (ะฟัะธะผะตะฝะธัั `new_schema.sql`)
   - ะะพะปััะธัั ะฟัะฐะฒะธะปัะฝัะน connection string ะธะท Dashboard
   - ะะธะณัะธัะพะฒะฐัั ะดะฐะฝะฝัะต ะธะท ะปะพะบะฐะปัะฝะพะน ะะ ะฒ Supabase
   - ะะฑะฝะพะฒะธัั `DATABASE_URL` ะฝะฐ Supabase connection

2. **ะัะพะฒะตัะธัั ะธ ะทะฐะฟัััะธัั Dev Server:**
   ```bash
   ps aux | grep "next dev" | grep -v grep
   # ะัะปะธ ะฝะต ะทะฐะฟััะตะฝ:
   cd /workspaces/srm-new && nohup npm run dev > /tmp/nextjs-server.log 2>&1 &
   ```

3. **ะะะะะะะ ะฝะต ะพััะฐะฝะฐะฒะปะธะฒะฐัั Dev Server:**
   - Dev server ัะฐะฑะพัะฐะตั ะฒ ัะพะฝะต (nohup)
   - ะัะต ะบะพะผะฐะฝะดั ะฒัะฟะพะปะฝััั ะฒ ะะขะะะะฌะะซะฅ ัะตัะผะธะฝะฐะปะฐั

**ะะตะท ัะฐะฑะพัะฐััะตะณะพ Dev Server ะฟัะธะปะพะถะตะฝะธะต ะะ ะะะะะขะะะข!**
**ะะตะท Supabase ะดะฐะฝะฝัั ะะะข!**

## โ ะะะะขะะงะะกะะะ ะะะะะะะ: ะะ ะะะะะ ะะะะะขะะฎะฉะะ โ

**ะะะะะขะะ ะะะะะะะ - ะะะะะะฏะ ะขะะะฌะะ ะขะ, ะงะขะ ะะะะกะฏะข:**
- **ะะะะะะฉะะะ ััะพะณะฐัั ะบะพะด, ะบะพัะพััะน ะฝะต ัะฒัะทะฐะฝ ั ัะตะบััะตะน ะทะฐะดะฐัะตะน**
- **ะะะะะะฉะะะ ะผะตะฝััั ััะพ-ะปะธะฑะพ ะบัะพะผะต ัะพะณะพ, ััะพ ัะฒะฝะพ ะทะฐะฟัะฐัะธะฒะฐะตััั**
- ะัะปะธ ะฝัะถะฝะพ ะธะทะผะตะฝะธัั ะฒััะพัั - ะผะตะฝัะน ะขะะะฌะะ ะฒััะพัั, ะฝะต ัะธัะธะฝั
- ะัะปะธ ะฝัะถะฝะพ ะธะทะผะตะฝะธัั ัะฒะตั - ะผะตะฝัะน ะขะะะฌะะ ัะฒะตั, ะฝะต ัะฐะทะผะตั
- ะะ ัะตัะฐะบัะพัะธ, ะะ "ัะปัััะฐะน", ะะ "ะพะฟัะธะผะธะทะธััะน" ััะดะพะผ ะปะตะถะฐัะธะน ะบะพะด
- ะะฐะฑะพัะฐััะธะต ัะธัะธ (ะณะฐัะผะพัะบะฐ ะบะพะฝัะฐะบัะพะฒ, ะฐะฝะธะผะฐัะธะธ ะธ ั.ะด.) - ะะ ะขะะะะะขะฌ
- ะะตะทัะปััะฐั (0+1)-1 = 0 ะะะะะะฃะกะขะะ - ััะพ ะฟัะพะฒะฐะป

**ะัะธ ะปัะฑะพะผ ะธะทะผะตะฝะตะฝะธะธ:**
1. ะะทะผะตะฝัะน ะะะะะะฃะ ัััะพะบ ะบะพะดะฐ
2. ะะต ััะพะณะฐะน ัะพัะตะดะฝะธะต ะฑะปะพะบะธ
3. ะะต ะผะตะฝัะน ััััะบัััั, ะตัะปะธ ััะพ ะฝะต ััะตะฑัะตััั ะดะปั ะทะฐะดะฐัะธ
4. ะัะพะฒะตัั ััะพ ะฝะต ัะปะพะผะฐะป ัััะตััะฒัััะธะน ััะฝะบัะธะพะฝะฐะป
5. **ะกะขะะะะ ัะปะตะดัะน ะทะฐะฟัะพัั**: ะตัะปะธ ัะบะฐะทะฐะฝะพ "ัะพะปัะบะพ ะฒััะพัั" - ััะพะณะฐะน ะขะะะฌะะ ะฒััะพัั

**ะฆะตะปั**: ะะตัะธัั ะทะฐะดะฐัั ะะ ัะปะพะผะฐะฒ ะฝะธัะตะณะพ ะดััะณะพะณะพ. ะะตะฝััั ะขะะะฌะะ ัะพ, ััะพ ะฟัะพััั.

## ๐พ ะะะะะะะ ะกะะฅะะะะะะะฏ ะะะะะซะฅ ะ ะะะะะะะ ะกะะะะะ ๐พ

**ะะะะะะฏ ะขะะงะะ ะกะะฅะะะะะะะฏ:**
- ะัะต ะดะฐะฝะฝัะต ะฒ ะผะพะดะฐะปะบะต ัะดะตะปะบะธ (ะฝะฐะทะฒะฐะฝะธะต, ะฑัะดะถะตั, ะบะพะฝัะฐะบัั, ะบะพะผะฟะฐะฝะธะธ, ะฟะพะปั) ััะฐะฝัััั **ะะะะะะะะ** ะฒ ัะพััะพัะฝะธะธ ะบะพะผะฟะพะฝะตะฝัะฐ
- ะกะพััะฐะฝะตะฝะธะต ะฒ ะฑะฐะทั ะดะฐะฝะฝัั ะฟัะพะธััะพะดะธั **ะขะะะฌะะ ะะะะะ ะะะะะะะ** - ะบะฝะพะฟะบะพะน ัะพััะฐะฝะตะฝะธั ะฒัะตะน ัะดะตะปะบะธ
- ะฃ ัะพัะผ ัะพะทะดะฐะฝะธั ะบะพะฝัะฐะบัะพะฒ ะธ ะบะพะผะฟะฐะฝะธะน **ะะะข** ัะฒะพะธั ะบะฝะพะฟะพะบ "ะกะพะทะดะฐัั"/"ะัะผะตะฝะฐ"
- ะะพะปัะทะพะฒะฐัะตะปั ะทะฐะฟะพะปะฝัะตั ะฒัะต ะฟะพะปั, ะทะฐัะตะผ ะถะผัั ะพะดะฝั ะบะฝะพะฟะบั "ะกะพััะฐะฝะธัั" - ะธ ะฒัะต ะธะทะผะตะฝะตะฝะธั ะฟัะธะผะตะฝััััั ัะฐะทะพะผ
- ะญัะพ ะพะฑะตัะฟะตัะธะฒะฐะตั ะฐัะพะผะฐัะฝะพััั ะพะฟะตัะฐัะธะน ะธ ัะดะพะฑััะฒะพ UX (ะฝะต ะฝัะถะฝะพ ะบะปะธะบะฐัั 10 ัะฐะท)

**ะัะธ ัะฐะทัะฐะฑะพัะบะต ะฝะพะฒัั ัะพัะผ ะฒ ะผะพะดะฐะปะบะต:**
- ะะ ะดะพะฑะฐะฒะปัะน ะพัะดะตะปัะฝัะต ะบะฝะพะฟะบะธ ัะพััะฐะฝะตะฝะธั ะดะปั ะบะฐะถะดะพะณะพ ะฟะพะปั
- ะัะต ะดะฐะฝะฝัะต ะดะพะปะถะฝั ััะฐะฝะธัััั ะฒ useState ะดะพ ะผะพะผะตะฝัะฐ ะพะฑัะตะณะพ ัะพััะฐะฝะตะฝะธั
- ะคะพัะผะฐ ะฟัะพััะพ ัะฐัะบััะฒะฐะตััั - ะฟะพะปัะทะพะฒะฐัะตะปั ะฒะฒะพะดะธั ะดะฐะฝะฝัะต - ะทะฐะบััะฒะฐะตั ัะพัะผั - ะดะฐะฝะฝัะต ะพััะฐัััั ะฒ ะฟะฐะผััะธ

---

## Current Session Focus (November 25, 2025)

### What We're Working On
**Subscription System + Chat Filters UI** - ะะฐะฒะตััะตะฝะพ! โ

### Latest Completed Tasks
1. โ **ะกะธััะตะผะฐ ัะฐัะธัะธะบะฐัะธะธ (ะฟะพะปะฝะพัััั ะณะพัะพะฒะฐ)**:
   - ะขะฐะฑะปะธัั ะะ: `subscriptions`, `features`, `subscription_features`
   - 3 ัะฐัะธัะฐ: Free, Professional (1990โฝ), Business (4990โฝ)
   - 10 ััะฝะบัะธะน ั ัะฐะทะฝัะผะธ ััะพะฒะฝัะผะธ ะดะพัััะฟะฐ
   - Helper `/src/lib/subscription.ts` ั ััะฝะบัะธัะผะธ ะฟัะพะฒะตัะบะธ ะดะพัััะฟะฐ
   - API endpoints: `/api/account/subscription`, `/api/account/check-feature`
   - ะะธะณัะฐัะธั 0004_subscriptions.sql ะฟัะธะผะตะฝะตะฝะฐ
   - ะัะต ะฐะบะบะฐัะฝัั ะฟะพะปััะธะปะธ FREE ัะฐัะธั ะฐะฒัะพะผะฐัะธัะตัะบะธ
   - ะะพะบัะผะตะฝัะฐัะธั: `SUBSCRIPTION_SYSTEM.md`

2. โ **UI ัะธะปัััะพะฒ ัะฐัะฐ (ะบะฐะบ ะฒ amoCRM)**:
   - ะฃะฑัะฐะฝั ะทะตะปะตะฝัะต ัะตะณะธ ะฐะบัะธะฒะฝัั ัะธะปัััะพะฒ (ัะพะปัะบะพ ัะธะฝัั ะพะฑะฒะพะดะบะฐ)
   - ะฃะผะตะฝััะตะฝะฐ ัะธัะธะฝะฐ ัะปะตะผะตะฝัะพะฒ ัะธะปัััะพะฒ (ะบะพะผะฟะฐะบัะฝัะน ะฒะธะด)
   - ะกัััะบัััะฐ ะธะท 3 ะบะพะปะพะฝะพะบ:
     - ะะตะฒะฐั (w-52): ะัััััะต ัะธะปัััั ะฒะตััะธะบะฐะปัะฝะพ
     - ะกัะตะดะฝัั (w-64): ะงะตะบะฑะพะบัั ะธ dropdown "ะขะธะฟั ัะพะฑััะธะน:"
     - ะัะฐะฒะฐั (w-80): ะขะตะบัั ะฟัะพ ัะฐัะธั ยซะัะพัะตััะธะพะฝะฐะปัะฝัะนยป
   - ะะพะปะต ะฟะพะธัะบะฐ ะพัะบััะฒะฐะตั/ะทะฐะบััะฒะฐะตั ัะธะปัััั (overlay)
   - ะัะต ะฑะฐะทะพะฒัะต ัะธะปัััั ะดะพัััะฟะฝั FREE ะฟะพะปัะทะพะฒะฐัะตะปัะผ
   - ะขะพะปัะบะพ ัะฐะผ ะฟะพะธัะบ ะฟะปะฐัะฝัะน (Professional+)

**Status**: โ COMPLETE - ะขะฐัะธัะฝะฐั ัะธััะตะผะฐ + UI ัะธะปัััะพะฒ ะณะพัะพะฒั

### Previous Sessions
- **November 21, 2025**: Chat Feature with Advanced Filters โ
- **November 25, 2025**: Subscription System + UI Refinements โ

### System State
- PostgreSQL container: **Running** (srm-postgres, Docker)
- Database: **ACCOUNT hierarchy** - ะฟะพะปะฝะฐั ะผัะปััะธัะตะฝะฐะฝัะฝะพััั
- Dev server: **Running** ะฝะฐ http://localhost:3000 (ะะะะะะะ ะะ ะะกะขะะะะะะะะะขะฌ!)
- Auth system: **Active** ั JWT (jose ะดะปั Edge, jsonwebtoken ะดะปั API)
- PostgreSQL trigger: **create_default_stages_for_pipeline()** ะฐะบัะธะฒะตะฝ
- Test accounts: 2 ะฐะบะบะฐัะฝัะฐ ั ะธะทะพะปะธัะพะฒะฐะฝะฝัะผะธ ะดะฐะฝะฝัะผะธ
- UI Style: **amoCRM-inspired** - ะบะพะผะฟะฐะบัะฝัะน sidebar, ะปะตะฒะฐั ะผะพะดะฐะปะบะฐ

---

## Current UI Architecture (November 21, 2025)

### ๐จ Sidebar Design (Narrow amoCRM Style)
**File**: `/workspaces/srm-new/src/components/Sidebar.tsx`

**Specifications**:
- **Width**: `w-20` (80px) - ัะทะบะธะน ะบะพะผะฟะฐะบัะฝัะน ะดะธะทะฐะนะฝ
- **Layout**: ะะตััะธะบะฐะปัะฝัะน - ะธะบะพะฝะบะฐ ัะฒะตััั, ัะตะบัั ัะฝะธะทั
- **z-index**: `z-50` (ัะฐะผัะน ะฒะตััะฝะธะน ัะปะพะน)
- **Logo**: "S" (ัะพะบัะฐัะตะฝะฝะฐั ะฒะตััะธั "srm")
- **Navigation Items**:
  ```tsx
  { href: '/', label: 'ะะฐะฑะพัะธะน ััะพะป', icon: '๐' }
  { href: '/leads', label: 'ะกะดะตะปะบะธ', icon: '๐ผ' }
  { href: '/contacts', label: 'ะะพะฝัะฐะบัั', icon: '๐ค' }
  { href: '/companies', label: 'ะะพะผะฟะฐะฝะธะธ', icon: '๐ข' }
  { href: '/tasks', label: 'ะะฐะดะฐัะธ', icon: 'โ' }
  { href: '/lists', label: 'ะกะฟะธัะบะธ', icon: '๐' }
  { href: '/analytics', label: 'ะะฝะฐะปะธัะธะบะฐ', icon: '๐' }
  { href: '/settings', label: 'ะะฐัััะพะนะบะธ', icon: 'โ๏ธ' }
  ```
- **Item Structure**: `flex flex-col items-center` ั `text-2xl` ะธะบะพะฝะบะพะน ะธ `text-xs` ัะตะบััะพะผ
- **Active State**: `bg-slate-800` ะดะปั ัะตะบััะตะณะพ ัะฐะทะดะตะปะฐ
- **Hover**: `hover:bg-slate-800` ะดะปั ะธะฝัะตัะฐะบัะธะฒะฝะพััะธ

### ๐ช Deal Modal Positioning (Left Side)
**File**: `/workspaces/srm-new/src/components/DealModal.tsx`

**Layer Structure** (ัะฝะธะทั ะฒะฒะตัั):
1. **Backdrop** (`z-10`): ะะฐัะตะผะฝะตะฝะธะต ัะฟัะฐะฒะฐ ะพั sidebar
   - `left: '80px'` - ะฝะฐัะธะฝะฐะตััั ะฟะพัะปะต sidebar
   - `bg-black/50` - ะฟะพะปัะฟัะพะทัะฐัะฝัะน ัะตัะฝัะน
   - `onClick={handleBackdropClick}` - ะทะฐะบัััะธะต ะฟะพ ะบะปะธะบั ะฒะฝะต ะผะพะดะฐะปะบะธ
   - Fade ะฐะฝะธะผะฐัะธั: `fadeIn 0.3s` / `fadeOut 0.3s`

2. **Modal** (`z-20`): ะะพะฝัะตะนะฝะตั ะผะพะดะฐะปะบะธ
   - `left: '80px'` - ะฟะพะทะธัะธั ััะดะพะผ ั sidebar
   - `width: '580px'` - ัะธะบัะธัะพะฒะฐะฝะฝะฐั ัะธัะธะฝะฐ
   - `bg-slate-800` - ัะตะผะฝัะน ัะพะฝ
   - Transform ะฐะฝะธะผะฐัะธั: ะฒัะตะทะถะฐะตั ะธะท-ะฟะพะด sidebar
   - `onClick={(e) => e.stopPropagation()}` - ะบะปะธะบะธ ะฝะต ะทะฐะบััะฒะฐัั
   - **Tabs**: info | tasks | notes | activity | **chat** โจ

3. **Sidebar** (`z-50`): ะัะตะณะดะฐ ะฟะพะฒะตัั ะฒัะตะณะพ

### ๐ฌ Chat Feature (November 21, 2025) โจ
**File**: `/workspaces/srm-new/src/components/DealModal.tsx`

**ะกะธััะตะผะฐ ะฟะตัะตะฟะธัะบะธ (ะัะดะตะปัะฝะฐั ะฟะฐะฝะตะปั ัะฟัะฐะฒะฐ):**
- **ะััะธัะตะบัััะฐ**: ะัะดะตะปัะฝัะน `<div>` ัะฟัะฐะฒะฐ ะพั ะผะพะดะฐะปะบะธ (left: 660px, right: 0)
- **ะขะธะฟั ัะพะพะฑัะตะฝะธะน**: 
  - ๐ฌ ะงะฐั (ัะธะฝะธะน, bg-blue-600)
  - ๐ ะัะธะผะตัะฐะฝะธะต (ะถะตะปััะน, bg-yellow-600)
  - โ ะะฐะดะฐัะฐ (ะทะตะปะตะฝัะน, bg-green-600)
- **@ะฃะฟะพะผะธะฝะฐะฝะธั**: Dropdown ั ะฑะพัะฐะผะธ, ะพัะดะตะปะฐะผะธ, ะฟะพะปัะทะพะฒะฐัะตะปัะผะธ
- **ะัะฑะพั ะฟะพะปััะฐัะตะปั**: Dropdown ั ัะธะปัััะฐัะธะตะน (ะฑะพัั/ะพัะดะตะปั/ะฟะพะปัะทะพะฒะฐัะตะปะธ)
- **ะะปั ะทะฐะดะฐั**: ะะพะฟะพะปะฝะธัะตะปัะฝัะน dropdown "ะกะฒัะทะฐัััั:" (๐ ะัััะตัะฐ/๐ ะะฒะพะฝะพะบ/โ๏ธ ะะธััะผะพ/โ๏ธ ะััะณะพะน)

**ะกะธััะตะผะฐ ัะธะปัััะฐัะธะธ (amoCRM style):**
- **ะะพะธัะบ**: Input ั placeholder "ะะพะธัะบ ะธ ัะธะปััั"
- **Overlay ะฟะฐะฝะตะปั**: position: absolute, ะพัะบััะฒะฐะตััั ะฟะพะฒะตัั ัะฐัะฐ, z-index: 40
- **ะกัััะบัััะฐ (2 ะบะพะปะพะฝะบะธ)**:
  - **ะะตะฒะฐั (240px)**: ะัััััะต ัะธะปัััั-ะบะฝะพะฟะบะธ
    - ะัะต ัะพะฑััะธั (ะฟะพ ัะผะพะปัะฐะฝะธั)
    - ะขะพะปัะบะพ ัะฐัั
    - ะขะพะปัะบะพ ัะฐัั ั ะบะปะธะตะฝัะฐะผะธ
  - **ะัะฐะฒะฐั (flex-1)**: ะะตัะฐะปัะฝัะต ะฝะฐัััะพะนะบะธ
    - โ๏ธ ะกะพะพะฑัะตะฝะธั ัะฐัะพะฒ: ะัะต/ะก ะบะปะธะตะฝัะฐะผะธ/ะะฝัััะตะฝะฝะธะต
    - โ๏ธ ะกะฒัะทะฐะฝะฝัะต ะพะฑัะตะบัั: ะัะต (ั dropdown ะฒัะฑะพัะฐ: ะะพะฝัะฐะบัั/ะะพะผะฟะฐะฝะธะธ/ะกะดะตะปะบะธ/ะะฐะดะฐัะธ)
    - ะขะธะฟั ัะพะฑััะธะน: dropdown ั ัะตะบะฑะพะบัะฐะผะธ + ะบะฝะพะฟะบะธ OK/ะัะผะตะฝะธัั

**State ัะฟัะฐะฒะปะตะฝะธั:**
```tsx
const [chatFilter, setChatFilter] = useState<'all' | 'chats-only' | 'chats-with-clients'>('all')
const [chatMessagesEnabled, setChatMessagesEnabled] = useState(false)
const [selectedRelatedObjects, setSelectedRelatedObjects] = useState<string[]>([])
const [selectedEventTypes, setSelectedEventTypes] = useState<string[]>([])
const [accountUsers, setAccountUsers] = useState<any[]>([]) // ัะตะฐะปัะฝัะต ะฟะพะปัะทะพะฒะฐัะตะปะธ ะธะท ะะ
```

**API Integration:**
- **Endpoint**: `/api/account/users` (GET)
- **Auth**: ัะตัะตะท `getUserFromRequest(request)` ะฒ API route
- **Response**: `[{ id, email, full_name, role }]`
- **ะะฐะณััะทะบะฐ**: `loadAccountUsers()` ะฟัะธ ะพัะบัััะธะธ ะผะพะดะฐะปะบะธ

**UI Features:**
- โ ะะตะปะตะฝัะต ัะตะณะธ ะฐะบัะธะฒะฝัั ัะธะปัััะพะฒ (ะผะพะถะฝะพ ัะดะฐะปะธัั ะบะปะธะบะพะผ)
- โ ะะฐะบัััะธะต ะฟะฐะฝะตะปะธ ะฟัะธ ะบะปะธะบะต ะฒะฝะต `.chat-filters-panel`
- โ ะะพะธัะบ ั ะธะบะพะฝะบะพะน ะพัะธััะบะธ
- โ ะะฐััะพะผะฝัะน scrollbar (8px, slate-600 thumb, slate-800 track)
- โ ะะฝะธะผะฐัะธะธ ัะธะฝััะพะฝะธะทะธัะพะฒะฐะฝั ั ะผะพะดะฐะปะบะพะน (transform: translateX)
- โ Responsive design
- ๐ TODO: Backend API integration
- ๐ TODO: WebSocket ะดะปั real-time

**Animation Logic**:
```tsx
// States
const [isOpening, setIsOpening] = useState(true)  // ะะฐัะฐะปัะฝะฐั ะฐะฝะธะผะฐัะธั
const [isClosing, setIsClosing] = useState(false) // ะะฝะธะผะฐัะธั ะทะฐะบัััะธั

// ะัะธ ะผะพะฝัะธัะพะฒะฐะฝะธะธ
useEffect(() => {
  requestAnimationFrame(() => setIsOpening(false)) // ะะฐะฟััะบ ะฐะฝะธะผะฐัะธะธ
}, [])

// Transform ะทะฝะฐัะตะฝะธั
transform: isClosing 
  ? 'translateX(-100%)'           // ะะฐะบัััะธะต: ัะตะทะถะฐะตั ะฒะปะตะฒะพ
  : (isOpening 
      ? 'translateX(-100%)'       // ะะฐัะฐะปะพ: ัะบัััะฐ ัะปะตะฒะฐ
      : 'translateX(0)')          // ะัะบัััะฐ: ะฝะฐ ะผะตััะต

transition: isOpening ? 'none' : 'transform 0.3s ease-out'
```

**Result**: 
- โ ะะพะดะฐะปะบะฐ ะฟะปะฐะฒะฝะพ ะฒัะตะทะถะฐะตั ะธะท-ะฟะพะด sidebar (ัะปะตะฒะฐ ะฝะฐะฟัะฐะฒะพ)
- โ Sidebar ะฒัะตะณะดะฐ ะฒะธะดะธะผ ะธ ะบะปะธะบะฐะฑะตะปะตะฝ
- โ Backdrop ะทะฐัะตะผะฝัะตั ัะพะปัะบะพ ะพะฑะปะฐััั ัะฟัะฐะฒะฐ ะพั sidebar
- โ ะะปะธะบ ะฟะพ backdrop ะทะฐะบััะฒะฐะตั ะผะพะดะฐะปะบั
- โ ะะปะธะบ ะฟะพ ะผะพะดะฐะปะบะต ะะ ะทะฐะบััะฒะฐะตั ะตั
- โ ะะฝะธะผะฐัะธั ะทะฐะบัััะธั: ะผะพะดะฐะปะบะฐ ัะตะทะถะฐะตั ะพะฑัะฐัะฝะพ ะฟะพะด sidebar

### Test Credentials
| Email | Password | Account | Pipelines |
|-------|----------|---------|-----------|
| `admin@test.com` | `parol123` | ะะบะบะฐัะฝั admin | 2 ะฒะพัะพะฝะบะธ |
| `admin` | `admin123` | ะะปะฐะฒะฝัะน ะฐะดะผะธะฝะธัััะฐัะพั | 1 ะฒะพัะพะฝะบะฐ |
| `manager` | `manager123` | ะะพะผะฟะฐะฝะธั 2 | 2 ะฒะพัะพะฝะบะธ |

---

## Recent Work Summary (November 19, 2025)

### ๐จ DEAL MODAL UI/UX COMPLETE โ

**ะะพััะธะถะตะฝะธะต:** ะะพะผะฟะฐะบัะฝะฐั ะบะฐััะพัะบะฐ ัะดะตะปะบะธ ั ะฟะพะปะฝัะผ ัะตะดะฐะบัะธัะพะฒะฐะฝะธะตะผ ะฒัะตั ะฟะพะปะตะน, ัะพััะฐะฝะตะฝะธะต ัะพะปัะบะพ ะฟะพ ะบะฝะพะฟะบะต.

**ะะตะฐะปะธะทะพะฒะฐะฝะฝัะต ัะปัััะตะฝะธั:**

#### 1. ะะพะผะฟะฐะบัะฝัะน ะดะธะทะฐะนะฝ ะฒ ััะธะปะต amoCRM โ
- ะฃะฑัะฐะฝั ะทะฐะณะพะปะพะฒะบะธ ัะตะบัะธะน (ะะฑัะฐั ะธะฝัะพัะผะฐัะธั, ะะพะฝัะฐะบั, ะะพะผะฟะฐะฝะธั)
- ะฃะผะตะฝััะตะฝั ะพััััะฟั: py-3 โ py-2 โ py-1
- ะะธะทัะฐะปัะฝัะต ะณัะฐะฝะธัั ัะตัะตะท bg-slate-700/30 ะบะฐััะพัะบะธ
- gap-1.5 ะผะตะถะดั ัะปะตะผะตะฝัะฐะผะธ ะดะปั ะฟะปะพัะฝะพััะธ
- ะฃะฑัะฐะฝะฐ ะบะฝะพะฟะบะฐ "ะตัะต" ะฒะฝะธะทั ะบะฐััะพัะบะธ

#### 2. ะะบะบะพัะดะตะพะฝ ะบะพะฝัะฐะบัะพะฒ โ
- Smooth height transition: 0.35s ease-in-out
- activeContactIndex state ะดะปั ัะฟัะฐะฒะปะตะฝะธั
- ะััะพัั: inactive 60px โ active 400px
- Inline ััะธะปะธ ะดะปั ะฝะฐะดะตะถะฝะพะน ะฐะฝะธะผะฐัะธะธ

#### 3. ะัะต ะฟะพะปั ัะตะดะฐะบัะธััะตะผัะต โ
**ะะพะฝัะฐะบั:**
- phone (type="tel")
- email (type="email")
- position (type="text")
- company_id (ะบะพะฝัะตะบััะฝะพะต ะผะตะฝั ั ะฟะพะธัะบะพะผ)
- budget2 (type="number") - ะฝะพะฒะพะต ะฟะพะปะต
- meeting_date (type="datetime-local") - ะฝะพะฒะพะต ะฟะพะปะต

**ะะพะผะฟะฐะฝะธั:**
- phone (type="tel")
- email (type="email")
- website (type="url")
- address (type="text")

#### 4. ะกะพััะฐะฝะตะฝะธะต ัะพะปัะบะพ ะฟะพ ะบะฝะพะฟะบะต โ
- ะฃะฑัะฐะฝั ะฒัะต onBlur handlers (auto-save)
- ะัะต ะธะทะผะตะฝะตะฝะธั ะพััะปะตะถะธะฒะฐัััั ัะตัะตะท setHasChanges(true)
- ะะพะฝัะพะปะธะดะธัะพะฒะฐะฝะพ ะฒ handleSave() - ัะฐะณะธ 5-6
- Exit confirmation ัะฐะฑะพัะฐะตั ัะตัะตะท hasChanges flag

#### 5. ะะพะผะฟะฐะฝะธั ะฒ ัะฐะทะดะตะปะต ะะพะฝัะฐะบั โ
- ะะตะทะฐะฒะธัะธะผะฐ ะพั ัะตะบัะธะธ ะะพะผะฟะฐะฝะธั
- ะะพะฝัะตะบััะฝะพะต ะผะตะฝั: ัะตะดะฐะบัะธัะพะฒะฐัั / ัะดะฐะปะธัั ะฟัะธะฒัะทะบั
- ะะพะธัะบ ะฟะพ ะบะพะผะฟะฐะฝะธัะผ ั ัะธะปัััะฐัะธะตะน
- editingContactCompany state ะดะปั ัะฟัะฐะฒะปะตะฝะธั

#### 6. Database Schema Extensions โ
```sql
ALTER TABLE contacts ADD COLUMN budget2 INTEGER;
ALTER TABLE contacts ADD COLUMN meeting_date TIMESTAMP;
-- companies.email, companies.address ัะถะต ัััะตััะฒะพะฒะฐะปะธ
```

#### 7. API Updates โ
- `/api/contacts/[id]` - PUT handler ะฒะบะปััะฐะตั budget2, meeting_date
- `/api/companies/[id]` - ัะถะต ะฟะพะดะดะตัะถะธะฒะฐะป ะฒัะต ะฟะพะปั

**ะคะฐะนะปั:**
- `src/components/DealModal.tsx` - ะฟะพะปะฝัะน ัะตัะฐะบัะพัะธะฝะณ (1506 ัััะพะบ)
- `src/app/api/contacts/[id]/route.ts` - ะดะพะฑะฐะฒะปะตะฝั ะฝะพะฒัะต ะฟะพะปั
- Database: ัะฐััะธัะตะฝะฐ ััะตะผะฐ contacts

### ๐ฏ MULTI-TENANCY COMPLETE โ

**ะะพััะธะถะตะฝะธะต:** ะะพะปะฝะฐั ะธะทะพะปััะธั ะดะฐะฝะฝัั ะฟะพ ะฐะบะบะฐัะฝัะฐะผ + ะฐะฒัะพะผะฐัะธัะตัะบะพะต ัะพะทะดะฐะฝะธะต ะดะตัะพะปัะฝัั ััะฐะฟะพะฒ ะฒะพัะพะฝะพะบ.

### ๐๏ธ DATABASE MIGRATION: ACCOUNT Hierarchy โ

**ะัะพะฑะปะตะผะฐ:** ะกัะฐัะฐั ััะตะผะฐ ะฝะต ะฟะพะดะดะตัะถะธะฒะฐะปะฐ ะผัะปััะธัะตะฝะฐะฝัะฝะพััั, ะดะฐะฝะฝัะต ัะผะตัะธะฒะฐะปะธัั ะผะตะถะดั ะฟะพะปัะทะพะฒะฐัะตะปัะผะธ.

**ะะตัะตะฝะธะต - ะะพะฒะฐั ะธะตัะฐััะธัะตัะบะฐั ััััะบัััะฐ:**
```
ACCOUNT (ะฒะตััะฝะธะน ััะพะฒะตะฝั - ะพัะณะฐะฝะธะทะฐัะธั)
โโโ USERS (ะฟะพะปัะทะพะฒะฐัะตะปะธ ะฐะบะบะฐัะฝัะฐ)
โโโ COMPANIES (ะบะพะผะฟะฐะฝะธะธ - ะฝะตะทะฐะฒะธัะธะผะฐั ัััะฝะพััั)
โโโ CONTACTS (ะบะพะฝัะฐะบัั - ะฝะตะทะฐะฒะธัะธะผะฐั ัััะฝะพััั)  
โโโ PIPELINES (ะฒะพัะพะฝะบะธ ะฟัะพะดะฐะถ)
โ   โโโ STAGES (ััะฐะฟั)
โ       โโโ DEALS (ัะดะตะปะบะธ)
โ           โโโ company_id โ COMPANIES
โ           โโโ DEAL_CONTACTS (many-to-many)
โ               โโโ contact_id โ CONTACTS
โโโ TASKS, NOTES, ACTIVITY_LOGS
```

**ะะปััะตะฒัะต ะฟัะธะฝัะธะฟั:**
1. ะะพะฝัะฐะบัั ะธ ะบะพะผะฟะฐะฝะธะธ - ะพัะดะตะปัะฝัะต ะฝะตะทะฐะฒะธัะธะผัะต ัััะฝะพััะธ ะฐะบะบะฐัะฝัะฐ
2. ะกะพะทะดะฐะฝะธะต ัะตัะตะท ะบะฐััะพัะบั ัะดะตะปะบะธ ะดะพะฑะฐะฒะปัะตั ะฒ ะพะฑัะธะน ัะฟะธัะพะบ ะฐะบะบะฐัะฝัะฐ
3. ะัะธะฒัะทะบะฐ ัะตัะตะท ID (company_id, deal_contacts ัะฐะฑะปะธัะฐ)
4. ะัะต ะดะฐะฝะฝัะต ะธะทะพะปะธัะพะฒะฐะฝั ะฟะพ account_id
5. ะัะธ ัะพะทะดะฐะฝะธะธ ะฐะบะบะฐัะฝัะฐ ะฐะฒัะพะผะฐัะธัะตัะบะธ ัะพะทะดะฐะตััั ะดะตัะพะปัะฝะฐั ะฒะพัะพะฝะบะฐ (ััะธะณะณะตั)

**ะคะฐะนะปั:**
- `new_schema.sql` - ะฟะพะปะฝะฐั ะฝะพะฒะฐั ััะตะผะฐ (11 ัะฐะฑะปะธั)
- ะัะธะผะตะฝะตะฝะพ ัะตัะตะท Docker exec ะบ ะปะพะบะฐะปัะฝะพะน ะะ
- `drizzle/seed-new.ts` - ัะตััะพะฒัะต ะดะฐะฝะฝัะต (4 ัะดะตะปะบะธ, 3 ะบะพะผะฟะฐะฝะธะธ, 3 ะบะพะฝัะฐะบัะฐ)

### ๐ง API FIXES: Column Name Mismatches โ

**ะัะพะฑะปะตะผะฐ:** API ัะพััั ะธัะฟะพะปัะทะพะฒะฐะปะธ ััะฐััะต ะฝะฐะทะฒะฐะฝะธั ะบะพะปะพะฝะพะบ โ 500 ะพัะธะฑะบะธ ะฟัะธ ะพัะบัััะธะธ ะบะฐััะพัะตะบ ัะดะตะปะพะบ.

**ะัะฟัะฐะฒะปะตะฝะธั:**
1. **tasks.due_at โ due_date** (2 ะผะตััะฐ)
   - `/api/stats/route.ts` - ััะฐัะธััะธะบะฐ ะทะฐะดะฐั
   - `/api/deals/[id]/route.ts` - ะทะฐะดะฐัะธ ัะดะตะปะบะธ

2. **notes.user_id โ created_by**
   - `/api/deals/[id]/route.ts` - ะทะฐะผะตัะบะธ ัะดะตะปะบะธ

3. **activity_logs.created_by โ user_id + entity โ entity_type**
   - `/api/deals/[id]/route.ts` - ะปะพะณะธ ะฐะบัะธะฒะฝะพััะธ

4. **deals.contact_id ัะดะฐะปะตะฝ** (ัะตะฟะตัั many-to-many ัะตัะตะท deal_contacts)
   - `/api/deals/[id]/route.ts` - ัะฑัะฐะฝ ะธะท SELECT

**ะะตะทัะปััะฐั:** ะะฐััะพัะบะธ ัะดะตะปะพะบ ัะตะฟะตัั ะพัะบััะฒะฐัััั ะฑะตะท ะพัะธะฑะพะบ โ

### ๐ง ะะะะขะะงะะกะะะ ะะกะะะะะะะะะ: Edge Runtime Compatibility โ

**ะัะพะฑะปะตะผะฐ:**
- Middleware ะธัะฟะพะปัะทะพะฒะฐะป `jsonwebtoken`, ะบะพัะพััะน ััะตะฑัะตั Node.js `crypto` ะผะพะดัะปั
- Edge Runtime ะฒ Next.js 15 ะฝะต ะฟะพะดะดะตัะถะธะฒะฐะตั Node.js crypto
- ะัะธะฑะบะฐ: "The edge runtime does not support Node.js 'crypto' module"
- ะะตะทัะปััะฐั: ะขะพะบะตะฝ ัััะฐะฝะฐะฒะปะธะฒะฐะปัั, ะฝะพ middleware ะฝะต ะผะพะณ ะตะณะพ ะฟัะพะฒะตัะธัั โ ะฑะตัะบะพะฝะตัะฝัะน ัะตะดะธัะตะบั

**ะะตัะตะฝะธะต:**
1. ะฃััะฐะฝะพะฒะปะตะฝะฐ `jose` - Edge-ัะพะฒะผะตััะธะผะฐั JWT ะฑะธะฑะปะธะพัะตะบะฐ
2. Middleware ะฟะตัะตะฟะธัะฐะฝ ั async/await ะธ `jwtVerify`
3. API routes ะพััะฐะปะธัั ะฝะฐ `jsonwebtoken` (ะพะฝะธ ัะฐะฑะพัะฐัั ะฒ Node.js runtime)
4. ะะพะฑะฐะฒะปะตะฝะพ ะปะพะณะธัะพะฒะฐะฝะธะต ะดะปั ะพัะปะฐะดะบะธ

**ะคะฐะนะปั ะธะทะผะตะฝะตะฝั:**
- `/src/middleware.ts` - ะฟะพะปะฝัะน ัะตัะฐะบัะพัะธะฝะณ ั jose
- `package.json` - ะดะพะฑะฐะฒะปะตะฝะฐ ะทะฐะฒะธัะธะผะพััั jose

### ๐ ะฃะปัััะตะฝะธั ะฑะตะทะพะฟะฐัะฝะพััะธ ะธ UX โ

#### 1. ะะฐะปะธะดะฐัะธั ะฟะฐัะพะปะตะน (ะบะปะธะตะฝั + ัะตัะฒะตั)
**ะัะพะฑะปะตะผะฐ:** Chrome ะฟะพะบะฐะทัะฒะฐะป ะฟัะณะฐััะตะต ัะพะพะฑัะตะฝะธะต "ะฟะฐัะพะปั ัะฐัะบััั ะฒ ัะตะทัะปััะฐัะต ััะตัะบะธ ะดะฐะฝะฝัั" ะดะปั ัะปะฐะฑัั ะฟะฐัะพะปะตะน, ััะพ ะฟะพััะธะปะพ ัะตะฟััะฐัะธั ัะฐะนัะฐ.

**ะะตัะตะฝะธะต:**
- ะะธะฝะธะผัะผ 8 ัะธะผะฒะพะปะพะฒ (ะฑัะปะพ 6)
- ะะปะพะบะธัะพะฒะบะฐ ะฟะพะฟัะปััะฝัั ัะปะฐะฑัั ะฟะฐัะพะปะตะน: `12345678`, `password`, `qwerty123` ะธ ั.ะด.
- ะะฐะปะธะดะฐัะธั ะฝะฐ ะบะปะธะตะฝัะต ะฟะตัะตะด ะพัะฟัะฐะฒะบะพะน โ ะฟะพะปัะทะพะฒะฐัะตะปั ะฒะธะดะธั ะะะจ ัะตะบัั, ะฝะต Chrome
- ะะฐะปะธะดะฐัะธั ะฝะฐ ัะตัะฒะตัะต โ ะดะฒะพะนะฝะฐั ะทะฐัะธัะฐ
- ะะฝะดะธะบะฐัะพั ะฟัะพะณัะตััะฐ ะฟัะธ ะฒะฒะพะดะต ("ะัะต N ัะธะผะฒะพะปะพะฒ")

**ะคะฐะนะปั:**
- `/src/app/api/auth/register/route.ts` - server-side validation
- `/src/app/login/page.tsx` - client-side validation + ะธะฝะดะธะบะฐัะพั

#### 2. Case-Insensitive ะฐััะตะฝัะธัะธะบะฐัะธั โ
**ะขัะตะฑะพะฒะฐะฝะธะต:** Email ะธ ะฟะฐัะพะปั ะฝะต ะดะพะปะถะฝั ะทะฐะฒะธัะตัั ะพั ัะตะณะธัััะฐ (CapsLock ะฝะต ะฒะฐะถะตะฝ).

**ะะตะฐะปะธะทะฐัะธั:**
- Email: `LOWER(email) = LOWER($1)` ะฒ SQL ะทะฐะฟัะพัะฐั
- ะะฐัะพะปั: ะบะพะฝะฒะตััะฐัะธั ะฒ lowercase ะฟะตัะตะด ัะตัะธัะพะฒะฐะฝะธะตะผ/ััะฐะฒะฝะตะฝะธะตะผ
- ะกะพััะฐะฝะตะฝะธะต email ะฒ lowercase ะฟัะธ ัะตะณะธัััะฐัะธะธ

**ะะตะทัะปััะฐั:**
- `admin` / `parol123` โ
- `ADMIN` / `PAROL123` โ  
- `AdMiN` / `PaRoL123` โ

**ะคะฐะนะปั:**
- `/src/app/api/auth/login/route.ts` - case-insensitive ะฟะพะธัะบ ะธ ััะฐะฒะฝะตะฝะธะต
- `/src/app/api/auth/register/route.ts` - lowercase ััะฐะฝะตะฝะธะต

#### 3. ะะฑะฝะพะฒะปะตะฝะธะต ัะตััะพะฒะพะณะพ ะฐะบะบะฐัะฝัะฐ โ
- ะกัะฐััะน ะฟะฐัะพะปั: `123123` (ะฒัะทัะฒะฐะป ะฟัะตะดัะฟัะตะถะดะตะฝะธะต Chrome)
- ะะพะฒัะน ะฟะฐัะพะปั: `parol123` (ะฟัะพััะพะน, ะฝะพ ะฝะต ะฒ ะฑะฐะทะต ััะตัะตะบ)
- ะฅัั ะพะฑะฝะพะฒะปะตะฝ ะฒ ะะ ัะตัะตะท Docker exec

### ๐ ะััะธัะตะบัััะฐ ะฐะฒัะพัะธะทะฐัะธะธ

**JWT Flow:**
```
1. ะะพะปัะทะพะฒะฐัะตะปั ะฒะฒะพะดะธั ะปะพะณะธะฝ/ะฟะฐัะพะปั
2. Client-side ะฒะฐะปะธะดะฐัะธั (8+ ัะธะผะฒะพะปะพะฒ, ะฝะต ัะปะฐะฑัะน)
3. POST /api/auth/login
4. ะกะตัะฒะตั ะฟัะพะฒะตััะตั email (case-insensitive) + password (case-insensitive)
5. ะะพะทะฒัะฐั JWT ัะพะบะตะฝะฐ (30 ะดะฝะตะน, HS256)
6. ะะปะธะตะฝั ัะพััะฐะฝัะตั: localStorage + cookie (SameSite=Lax)
7. ะะตะดะธัะตะบั ะฝะฐ "/" ัะตัะตะท 100ms
8. Middleware ะฟัะพะฒะตััะตั cookie ั ะฟะพะผะพััั jose
9. ะัะปะธ ะฒะฐะปะธะดะตะฝ โ ะดะพัััะฟ, ะธะฝะฐัะต โ /login
```

**ะขะตัะฝะพะปะพะณะธะธ:**
- **API Routes**: `jsonwebtoken` (Node.js runtime) ะดะปั ัะพะทะดะฐะฝะธั ัะพะบะตะฝะพะฒ
- **Middleware**: `jose` (Edge runtime) ะดะปั ะฟัะพะฒะตัะบะธ ัะพะบะตะฝะพะฒ
- **ะฅะตัะธัะพะฒะฐะฝะธะต**: `bcryptjs` (10 rounds)
- **Cookies**: `SameSite=Lax`, 30 ะดะฝะตะน

### ๐จ UI/UX ะฐะฒัะพัะธะทะฐัะธะธ

**ะกััะฐะฝะธัะฐ `/login`:**
- โ Sliding animation (translateX) ะผะตะถะดั Login/Register
- โ ะัะฐะดะธะตะฝัะฝัะน ัะพะฝ (blue-50 to indigo-100)
- โ ะะฐะปะธะดะฐัะธั ั ะฟะพะฝััะฝัะผะธ ัะพะพะฑัะตะฝะธัะผะธ ะฝะฐ ััััะบะพะผ
- โ ะะฝะดะธะบะฐัะพั ะผะธะฝะธะผะฐะปัะฝะพะน ะดะปะธะฝั ะฟะฐัะพะปั
- โ ะะฒัะพะผะฐัะธัะตัะบะธะน ัะตะดะธัะตะบั ะฟะพัะปะต ััะฟะตัะฝะพะณะพ ะฒัะพะดะฐ
- โ Console.log ะดะปั ะพัะปะฐะดะบะธ (ะผะพะถะฝะพ ัะดะฐะปะธัั ะฒ production)

### ๐ ะะฐะทะฐ ะดะฐะฝะฝัั

**ะกัััะบัััะฐ users:**
**ะกัััะบัััะฐ users:**
```sql
- email VARCHAR(320) UNIQUE -- stored in lowercase
- password_hash VARCHAR(255) -- bcrypt, lowercase password
- full_name VARCHAR(255)
- role VARCHAR(32) DEFAULT 'manager'
```

**ะขัะธะณะณะตั:**
```sql
CREATE FUNCTION create_default_pipeline_for_user()
-- ะะฒัะพะผะฐัะธัะตัะบะธ ัะพะทะดะฐะตั "ะัะฝะพะฒะฝะฐั ะฒะพัะพะฝะบะฐ" + 5 ััะฐะฟะพะฒ ะฟัะธ INSERT ะฒ users
```

**ะะทะพะปััะธั ะดะฐะฝะฝัั:**
- `pipelines.user_id` โ ะบะฐะถะดัะน ะฟะพะปัะทะพะฒะฐัะตะปั ะฒะธะดะธั ัะพะปัะบะพ ัะฒะพะธ ะฒะพัะพะฝะบะธ
- `companies.user_id` โ ะธะทะพะปััะธั ะบะพะผะฟะฐะฝะธะน
- `contacts.user_id` โ ะธะทะพะปััะธั ะบะพะฝัะฐะบัะพะฒ

---

## ะะทะฒะตััะฝัะต ะฟัะพะฑะปะตะผั ะธ ัะตัะตะฝะธั

### โ ะะะจะะะ: Edge Runtime ะฝะต ะฟะพะดะดะตัะถะธะฒะฐะตั jsonwebtoken
- **ะัะปะพ**: Middleware ะบัะฐัะธะปัั ั crypto error
- **ะกัะฐะปะพ**: ะัะฟะพะปัะทัะตะผ jose ะดะปั Edge, jsonwebtoken ะดะปั API routes

### โ ะะะจะะะ: Chrome ะฟะพะบะฐะทัะฒะฐะตั "ััะตัะบะฐ ะดะฐะฝะฝัั" ะดะปั ัะปะฐะฑัั ะฟะฐัะพะปะตะน
- **ะัะปะพ**: ะัะณะฐััะตะต ัะพะพะฑัะตะฝะธะต ะฟะพััะธะปะพ ัะตะฟััะฐัะธั ัะฐะนัะฐ
- **ะกัะฐะปะพ**: ะะปะพะบะธััะตะผ ัะปะฐะฑัะต ะฟะฐัะพะปะธ ะะ ะพัะฟัะฐะฒะบะธ ัะพัะผั

### โ ะะะจะะะ: CapsLock ะผะตัะฐะป ะบะปะธะตะฝัะฐะผ ะฒัะพะดะธัั
- **ะัะปะพ**: ะะตะณะธัััะพะทะฐะฒะธัะธะผัะต email ะธ ะฟะฐัะพะปะธ
- **ะกัะฐะปะพ**: Case-insensitive ะดะปั ะพะฑะพะธั ะฟะพะปะตะน

---

## ะกะปะตะดัััะธะต ัะฐะณะธ (ะดะปั ะฑัะดััะธั ัะตััะธะน)

### ะัะธะพัะธัะตั 1: ะคัะฝะบัะธะพะฝะฐะป
- [ ] ะกััะฐะฝะธัะฐ ะฟัะพัะธะปั ะฟะพะปัะทะพะฒะฐัะตะปั
- [ ] ะะฝะพะฟะบะฐ "ะัะนัะธ" ะฒ Sidebar (ะพัะธััะบะฐ ัะพะบะตะฝะฐ)
- [ ] "ะะฐะฑัะปะธ ะฟะฐัะพะปั?" ััะฝะบัะธะพะฝะฐะป
- [ ] Email verification ะฟัะธ ัะตะณะธัััะฐัะธะธ (ะพะฟัะธะพะฝะฐะปัะฝะพ)

### ะัะธะพัะธัะตั 2: UX
- [ ] ะฃะดะฐะปะธัั console.log ะธะท production ะบะพะดะฐ
- [ ] Loading states ะฟัะธ ะฐะฒัะพัะธะทะฐัะธะธ
- [ ] Toast notifications ะดะปั ััะฟะตัะฝะพะณะพ ะฒัะพะดะฐ/ัะตะณะธัััะฐัะธะธ
- [ ] Remember me checkbox

### ะัะธะพัะธัะตั 3: ะะตะทะพะฟะฐัะฝะพััั
- [ ] Rate limiting ะฝะฐ login endpoint
- [ ] CSRF protection
- [ ] Refresh tokens (ะฒะผะตััะพ 30-ะดะฝะตะฒะฝัั access tokens)
- [ ] Session management (ะฐะบัะธะฒะฝัะต ัะตััะธะธ)

---

## Quick Reference

**Test Account:**
- Email: `admin` (ะธะปะธ ะปัะฑะพะน ัะตะณะธััั)
- Password: `parol123` (ะธะปะธ ะปัะฑะพะน ัะตะณะธััั)

**API Endpoints:**
- `POST /api/auth/login` - ะฒัะพะด
- `POST /api/auth/register` - ัะตะณะธัััะฐัะธั  
- `GET /api/auth/me` - ัะตะบััะธะน ะฟะพะปัะทะพะฒะฐัะตะปั

**Environment:**
```bash
DATABASE_URL="postgresql://postgres:postgres@localhost:5432/srm"
JWT_SECRET="your-super-secret-jwt-key-change-in-production-12345"
```

**Dev Server:**
```bash
npm run dev  # http://localhost:3000
```

---

## Files Changed This Session

```
src/middleware.ts                     # jose integration, async/await
src/app/login/page.tsx                # client-side validation, ะธะฝะดะธะบะฐัะพั
src/app/api/auth/login/route.ts       # case-insensitive auth
src/app/api/auth/register/route.ts    # password validation, lowercase storage
package.json                          # + jose dependency
memory-bank/activeContext.md          # this file
```

**Protected routes:**
- `/` - Dashboard
- `/leads` - ะกะดะตะปะบะธ
- `/contacts`, `/companies`, `/tasks`
- ะัะต API endpoints (ะบัะพะผะต auth)

### 5. Auth ััะธะปะธัั โ

**ะคะฐะนะป:** `/workspaces/srm-new/src/lib/auth.ts`

**ะคัะฝะบัะธะธ:**
- `getAuthToken()` - ะฟะพะปััะธัั ัะพะบะตะฝ ะธะท localStorage
- `getUser()` - ะฟะพะปััะธัั ะพะฑัะตะบั ะฟะพะปัะทะพะฒะฐัะตะปั
- `setAuth(token, user)` - ัะพััะฐะฝะธัั ะฒ localStorage + cookie
- `clearAuth()` - ะพัะธััะธัั ะฒัะต ะดะฐะฝะฝัะต
- `logout()` - ะฒัะนัะธ ะธ ัะตะดะธัะตะบั ะฝะฐ /login
- `authFetch(url, options)` - fetch ั ะฐะฒัะพะผะฐัะธัะตัะบะธะผ Bearer token

### 6. ะะฑะฝะพะฒะปะตะฝะธะต Sidebar โ

**ะะทะผะตะฝะตะฝะธั:**
- ะะพะฑะฐะฒะปะตะฝะฐ ะบะฝะพะฟะบะฐ "ะัะนัะธ" ะฒะฝะธะทั
- ะะผะฟะพัั ััะฝะบัะธะธ `logout` ะธะท `@/lib/auth`
- Flex layout ะดะปั ัะฐะทะผะตัะตะฝะธั ะบะฝะพะฟะบะธ ะฒะฝะธะทั

### 7. ะะฑะฝะพะฒะปะตะฝะธะต seed.ts โ

**ะะทะผะตะฝะตะฝะธั:**
- ะัะต ะฟะพะปัะทะพะฒะฐัะตะปะธ ัะพะทะดะฐัััั ั `password_hash`
- ะะฐัะพะปั ะดะปั ัะตััะพะฒ: **123456**
- Companies ะธ Contacts ะฟัะธะฒัะทะฐะฝั ะบ `user_id`
- ะะพัะพะฝะบะฐ ะฑะตััััั ะธะท auto-created ััะธะณะณะตัะพะผ
- Fallback ะตัะปะธ ััะธะณะณะตั ะฝะต ััะฐะฑะพัะฐะป

### 8. ะะะะขะะงะะกะะะ: ะัะปััะธัะตะฝะฐะฝัะฝะพััั ะธ ะธะทะพะปััะธั ะดะฐะฝะฝัั โ

**ะัะพะฑะปะตะผะฐ:**
- ะะพะปัะทะพะฒะฐัะตะปะธ ั `admin@test.com` ะฒะธะดะตะปะธ ะดะฐะฝะฝัะต ะดััะณะธั ะฐะบะบะฐัะฝัะพะฒ
- JWT ัะพะบะตะฝั ะฝะต ัะพะดะตัะถะฐะปะธ `account_id`
- API ะฝะต ัะธะปัััะพะฒะฐะปะธ ะดะฐะฝะฝัะต ะฟะพ ะฐะบะบะฐัะฝัั

**ะะตัะตะฝะธะต:**
1. **JWT payload ัะฐััะธัะตะฝ:**
   ```typescript
   { userId, accountId, email }
   ```

2. **ะะพะฑะฐะฒะปะตะฝะฐ ััะฝะบัะธั `getUserFromRequest()`** ะฒ `/src/lib/auth.ts`:
   ```typescript
   // ะะทะฒะปะตะบะฐะตั userId ะธ accountId ะธะท JWT cookie
   // ะัะฟะพะปัะทัะตััั ะฒะพ ะะกะะฅ API routes ะดะปั ะฐะฒัะพัะธะทะฐัะธะธ
   ```

3. **ะัะต API routes ะพะฑะฝะพะฒะปะตะฝั:**
   - `/api/contacts` - ัะธะปัััะฐัะธั ะฟะพ account_id
   - `/api/companies` - ัะธะปัััะฐัะธั ะฟะพ account_id  
   - `/api/deals` - ัะธะปัััะฐัะธั ะฟะพ account_id
   - `/api/pipelines` - ัะธะปัััะฐัะธั ะฟะพ account_id + POST endpoint
   - `/api/stats` - ัะธะปัััะฐัะธั ะฟะพ account_id

4. **Mapping ะฟะพะปะตะน ะดะปั ัะพะฒะผะตััะธะผะพััะธ:**
   - DB: `budget` โ Frontend: `value`
   - DB: `is_closed` โ Frontend: `closed`
   - ะกะพััะฐะฝะตะฝะธะต ะธัะฟะพะปัะทัะตั ะฟัะฐะฒะธะปัะฝัะต ะธะผะตะฝะฐ ะบะพะปะพะฝะพะบ

5. **ะฃะดะฐะปะตะฝะพ ะฟะพะปะต `contact_id` ะธะท deals:**
   - ะขะตะฟะตัั many-to-many ัะตัะตะท ัะฐะฑะปะธัั `deal_contacts`
   - Frontend ะฑะพะปััะต ะฝะต ะพัะฟัะฐะฒะปัะตั `contact_id` ะฒ PUT requests

**ะะตะทัะปััะฐั:**
- โ ะะพะปะฝะฐั ะธะทะพะปััะธั ะดะฐะฝะฝัั ะผะตะถะดั ะฐะบะบะฐัะฝัะฐะผะธ
- โ ะะฐะถะดัะน ะฐะบะบะฐัะฝั ะฒะธะดะธั ัะพะปัะบะพ ัะฒะพะธ ะฒะพัะพะฝะบะธ, ัะดะตะปะบะธ, ะบะพะฝัะฐะบัั, ะบะพะผะฟะฐะฝะธะธ
- โ ะัะพัะตััะธัะพะฒะฐะฝะพ ะฝะฐ 2 ะฐะบะบะฐัะฝัะฐั - ะธะทะพะปััะธั ัะฐะฑะพัะฐะตั
- โ ะะบะบะฐัะฝั 1: 16 ัะดะตะปะพะบ, 4 ะฒะพัะพะฝะบะธ
- โ ะะบะบะฐัะฝั 2: 0 ัะดะตะปะพะบ, 1 ะฒะพัะพะฝะบะฐ

### 9. ะะฒัะพะผะฐัะธัะตัะบะพะต ัะพะทะดะฐะฝะธะต ะดะตัะพะปัะฝัั ััะฐะฟะพะฒ ะฒะพัะพะฝะบะธ โ

**ะขัะตะฑะพะฒะฐะฝะธะต:**
> "ะขะตะฟะตัั ะฝะต ััะพะณะฐั ะัะฝะพะฒะฝัั ะฒะพัะพะฝะบั, ะฝัะถะฝะพ ะฝะฐัััะพะธัั ะดะตัะพะปัะฝะพะต ัะพะทะดะฐะฝะธะต ะฒะพัะพะฝะบะธ (ัะพ ะตััั ะดะตัะพะปัะฝัะต ััะฐะฟั ะฟัะธ ัะพะทะดะฐะฝะธะธ ะฒะพัะพะฝะบะธ)"

**ะะตัะตะฝะธะต - PostgreSQL Trigger:**
```sql
CREATE OR REPLACE FUNCTION create_default_stages_for_pipeline()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO stages (pipeline_id, name, position, color) VALUES
    (NEW.id, 'ะะตัะฒะธัะฝัะน ะบะพะฝัะฐะบั', 1, NULL),
    (NEW.id, 'ะะตัะตะณะพะฒะพัั', 2, NULL),
    (NEW.id, 'ะัะธะฝะธะผะฐัั ัะตัะตะฝะธะต', 3, NULL);
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_create_default_stages
AFTER INSERT ON pipelines
FOR EACH ROW
EXECUTE FUNCTION create_default_stages_for_pipeline();
```

**API Endpoint ะดะปั ัะพะทะดะฐะฝะธั ะฒะพัะพะฝะพะบ:**
- `POST /api/pipelines` - ัะพะทะดะฐะตั ะฒะพัะพะฝะบั + ััะธะณะณะตั ะฐะฒัะพะผะฐัะธัะตัะบะธ ะดะพะฑะฐะฒะปัะตั 3 ััะฐะฟะฐ
- Request: `{ "name": "ะะฐะทะฒะฐะฝะธะต ะฒะพัะพะฝะบะธ" }`
- Response: ะะพัะพะฝะบะฐ + ะผะฐััะธะฒ ัะพะทะดะฐะฝะฝัั ััะฐะฟะพะฒ

**ะะตะทัะปััะฐั:**
- โ ะัะธ ัะพะทะดะฐะฝะธะธ ะปัะฑะพะน ะฝะพะฒะพะน ะฒะพัะพะฝะบะธ ะฐะฒัะพะผะฐัะธัะตัะบะธ ัะพะทะดะฐัััั 3 ััะฐะฟะฐ
- โ "ะัะฝะพะฒะฝะฐั ะฒะพัะพะฝะบะฐ" ะฝะต ะทะฐััะพะฝััะฐ (ัะพััะฐะฝะธะปะฐ 5 ััะฐะฟะพะฒ)
- โ ะขัะธะณะณะตั ัะฐะฑะพัะฐะตั ะดะปั ะฒัะตั ะฐะบะบะฐัะฝัะพะฒ
- โ ะัะพัะตััะธัะพะฒะฐะฝะพ: ัะพะทะดะฐะฝะธะต ัะตัะตะท API ะธ ะฟััะผะพะน SQL INSERT
- โ ะัะพะฒะตัะบะฐ: "ะัะพะฒะตัะบะฐ ะฐะฒัะพัะพะทะดะฐะฝะธั" ะธะผะตะตั ัะพะฒะฝะพ 3 ััะฐะฟะฐ

**ะขะตััะพะฒัะต ะฐะบะบะฐัะฝัั (ะะะะะะะะะ):**
```
admin@test.com / parol123  (2 ะฒะพัะพะฝะบะธ: ะัะฝะพะฒะฝะฐั + ะัะพะฒะตัะบะฐ ะฐะฒัะพัะพะทะดะฐะฝะธั)
admin / admin123           (1 ะฒะพัะพะฝะบะฐ)
manager / manager123       (2 ะฒะพัะพะฝะบะธ: ะัะฝะพะฒะฝะฐั + ะขะตััะพะฒะฐั)
```

### 10. ะัะฟัะฐะฒะปะตะฝะธั ะบะพะฝัะธะณััะฐัะธะธ โ

**tsconfig.json:**
```json
"paths": {
  "@/*": ["./src/*"]
}
```

**.env.local:**
```
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/srm
JWT_SECRET=your-super-secret-jwt-key-change-in-production-12345
```

### 11. ะัะฟัะฐะฒะปะตะฝะธะต ะฟะฐัะพะปะตะน ะธ ะฐััะตะฝัะธัะธะบะฐัะธะธ โ

**ะัะพะฑะปะตะผะฐ:**
- ะะพะปัะทะพะฒะฐัะตะปั ะฝะต ะผะพะณ ะฒะพะนัะธ ั `admin@test.com` / `parol123`
- ะฅะตั ะฟะฐัะพะปั ะฒ ะฑะฐะทะต ะฝะต ัะพะฒะฟะฐะดะฐะป ั ะฒะฒะพะดะธะผัะผ ะฟะฐัะพะปะตะผ
- API ะธัะฟะพะปัะทะพะฒะฐะป `.toLowerCase()` ะดะปั ะฟะฐัะพะปะตะน (ัััะพะบะฐ 39 ะฒ login route)

**ะะตัะตะฝะธะต:**
1. ะะฑะฝะพะฒะปะตะฝั ัะตัะธ ะฟะฐัะพะปะตะน ะฒ ะฑะฐะทะต ะดะฐะฝะฝัั:
   ```bash
   # ะะตัะตัะพะทะดะฐะปะธ bcrypt ัะตัะธ ะดะปั ะฒัะตั ัะตััะพะฒัั ะฟะพะปัะทะพะฒะฐัะตะปะตะน
   admin@test.com โ parol123
   admin โ admin123
   manager โ manager123
   ```

2. ะัะพะฒะตัะตะฝะพ ัะตัะตะท curl - ะฒัะพะด ัะฐะฑะพัะฐะตั ะบะพััะตะบัะฝะพ

**ะะตะทัะปััะฐั:**
- โ ะัะต ัะตััะพะฒัะต ะฐะบะบะฐัะฝัั ะดะพัััะฟะฝั
- โ JWT ัะพะบะตะฝั ัะพะดะตัะถะฐั `accountId`
- โ ะััะตะฝัะธัะธะบะฐัะธั ัะฐะฑะพัะฐะตั ััะฐะฑะธะปัะฝะพ

---

## ะะฐะบ ะฟัะพัะตััะธัะพะฒะฐัั

1. **ะัะบัััั:** http://localhost:3001
2. **ะะตะดะธัะตะบั ะฝะฐ:** http://localhost:3001/login (middleware)
3. **ะะพะนัะธ:** admin@srm.dev / 123456
4. **ะะปะธ ะทะฐัะตะณะธัััะธัะพะฒะฐัั** ะฝะพะฒะพะณะพ ะฟะพะปัะทะพะฒะฐัะตะปั
5. **ะัะพะฒะตัะธัั:** ะะพัะพะฝะบะฐ ัะพะทะดะฐะฝะฐ ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฟัะธ ัะตะณะธัััะฐัะธะธ
6. **ะัะนัะธ:** ะะฝะพะฟะบะฐ "ะัะนัะธ" ะฒ sidebar

---

## ะกัััะบัััะฐ ะฐะฒัะพัะธะทะฐัะธะธ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ   Browser (Client)                  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ localStorage                 โ   โ
โ  โ  - auth_token (JWT)          โ   โ
โ  โ  - user (JSON)               โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ Cookies                      โ   โ
โ  โ  - auth_token (for middleware)โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
              โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ   Next.js Middleware                โ
โ  - ะัะพะฒะตััะตั cookie auth_token      โ
โ  - ะะตะดะธัะตะบั ะฝะฐ /login ะตัะปะธ ะฝะตั      โ
โ  - ะัะพะฟััะบะฐะตั /login ะธ /api/auth    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
              โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ   API Routes (/api/auth/*)          โ
โ  - register: ัะพะทะดะฐัั user + trigger โ
โ  - login: ะฟัะพะฒะตัะธัั + ะฒะตัะฝััั JWT   โ
โ  - me: ะฒะตัะฝััั ัะตะบััะตะณะพ user        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
              โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ   PostgreSQL                        โ
โ  - users (email, password_hash)     โ
โ  - pipelines (user_id FK)           โ
โ  - Trigger auto-create pipeline     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ะะฐะถะฝัะต ะฟะฐััะตัะฝั

### 1. Cookie + localStorage
- **Cookie** - ะดะปั server-side middleware
- **localStorage** - ะดะปั client-side ะปะพะณะธะบะธ
- ะะฑะฐ ัััะฐะฝะฐะฒะปะธะฒะฐัััั ะฟัะธ login/register

### 2. ะะฒัะพะผะฐัะธัะตัะบะฐั ะฒะพัะพะฝะบะฐ
```sql
TRIGGER: ะะพัะปะต INSERT ะฒ users
  โ CREATE pipeline "ะัะฝะพะฒะฝะฐั ะฒะพัะพะฝะบะฐ"
  โ CREATE 5 stages ะดะปั pipeline
```

### 3. JWT ัะพะบะตะฝั
- ะกัะพะบ ะถะธะทะฝะธ: 30 ะดะฝะตะน
- Payload: `{ userId, email }`
- Secret ะธะท .env.local

### 4. Sliding ัะพัะผะฐ
- Container: `width: 200%`
- ะะฒะต ัะพัะผั: ะฟะพ 50% ะบะฐะถะดะฐั
- Transform: `translateX(-100%)` ะดะปั ัะดะฒะธะณะฐ

---

### 3. UI/UX Improvements

#### Visual Structure (DealModal)
Divided into **3 clear sections** with visible separators:

1. **ะะะฉะะฏ ะะะคะะะะะฆะะฏ**
   - Title, price, stage, responsible
   - User, budget, deadline

2. **ะะะะขะะะข** (Multiple Contact Cards)
   - Each contact in separate card
   - Context menu (Edit, Remove)
   - Conditional field display:
     - Phone (if exists)
     - Email (if exists)
     - Position (if exists)
     - Company (always shown if contact has company)
   - "+ ะะพะฑะฐะฒะธัั ะบะพะฝัะฐะบั" button

3. **ะะะะะะะะฏ**
   - Company selector with autocomplete
   - Phone (if company has phone)
   - "+ ะกะพะทะดะฐัั ะบะพะผะฟะฐะฝะธั" button

#### Transactional Editing Pattern
```typescript
// Local state buffer
const [dealContacts, setDealContacts] = useState<Contact[]>([])
const [pendingContactChanges, setPendingContactChanges] = useState({
  added: string[],    // Contact IDs to add
  removed: string[]   // Contact IDs to remove
})

// Changes tracked but NOT saved
function handleAddContact(contactId: string) {
  // Update UI immediately
  // Store in pendingContactChanges.added
  // NO API call yet
}

// Batch save on "ะกะพััะฐะฝะธัั" click
async function handleSave() {
  // Save all deal fields
  // Process pendingContactChanges.added (POST each)
  // Process pendingContactChanges.removed (DELETE each)
  // Reload fresh data
  // Clear pending state
}
```

### 4. Context Menu Refactor
**Problem**: Multiple boolean states (`showCompanyMenu`, `showContactMenu`, etc.) didn't scale

**Solution**: Single unified state
```typescript
const [activeMenu, setActiveMenu] = useState<string | null>(null)

// Usage
{activeMenu === `contact-${contact.id}` && (
  <ContextMenu onClose={() => setActiveMenu(null)} />
)}
```

**Benefits**:
- Only one menu open at a time
- Scalable to unlimited menu types
- Simpler outside-click handling

---

## Active Implementation Details

### DealModal State Architecture (Current)
```typescript
// Deal data
const [deal, setDeal] = useState<Deal | null>(null)

// Edit buffer
const [editForm, setEditForm] = useState<any>({})

// Change tracking
const [hasChanges, setHasChanges] = useState(false)

// Contact management
const [dealContacts, setDealContacts] = useState<Contact[]>([])
const [pendingContactChanges, setPendingContactChanges] = useState({
  added: string[],
  removed: string[]
})

// Reference data
const [companies, setCompanies] = useState<Company[]>([])
const [allContacts, setAllContacts] = useState<Contact[]>([])
const [users, setUsers] = useState<User[]>([])
const [stages, setStages] = useState<Stage[]>([])

// UI state
const [activeTab, setActiveTab] = useState('info')
const [activeMenu, setActiveMenu] = useState<string | null>(null)
const [searchCompanyTerm, setSearchCompanyTerm] = useState('')
const [searchContactTerm, setSearchContactTerm] = useState('')
const [showCompanySearch, setShowCompanySearch] = useState(false)
const [showContactSearch, setShowContactSearch] = useState(false)
```

### Contact Card Template (Current)
```tsx
<div className="bg-slate-800 p-4 rounded-lg relative">
  {/* Context Menu Trigger */}
  <button onClick={() => setActiveMenu(`contact-${contact.id}`)}>
    โฎ
  </button>
  
  {/* Context Menu */}
  {activeMenu === `contact-${contact.id}` && (
    <div onClick={(e) => e.stopPropagation()}>
      <button onClick={handleEdit}>ะะตะดะฐะบัะธัะพะฒะฐัั</button>
      <button onClick={handleRemove}>ะฃะดะฐะปะธัั</button>
    </div>
  )}
  
  {/* Contact Name */}
  <div>{contact.first_name} {contact.last_name}</div>
  
  {/* Conditional Fields */}
  {contact.phone && <div>๐ {contact.phone}</div>}
  {contact.email && <div>โ๏ธ {contact.email}</div>}
  {contact.position && <div>๐ผ {contact.position}</div>}
  
  {/* Company Info (always shown if exists) */}
  {contact.company_name && (
    <div>๐ข {contact.company_name}</div>
  )}
</div>
```

---

## Recent Bugs Fixed

| Issue | Root Cause | Solution | Session |
|-------|-----------|----------|---------|
| TypeError: totalValue undefined | No null check | `(value || 0).toLocaleString()` | Current |
| TypeError: array.length undefined | API returned null | `(!array \|\| array.length === 0)` | Current |
| TypeError: companies.map not function | API returned non-array | `Array.isArray(data) ? data : []` | Current |
| All pages showing empty data | Docker container stopped | `docker start srm-postgres` | Current |
| SQL error: `column "entity_type"` | Typo in activity_logs query | Changed to `entity` column | Previous |
| API error: `column "position"` on companies | Inserting into wrong table | Removed from companies POST | Previous |
| Context menu not closing | stopPropagation on trigger | Move to menu body only | Previous |
| Sections not visually separated | No border between sections | Added `border-t` on section containers | Previous |
| Contact changes save immediately | Direct API calls | Buffered in `pendingContactChanges` | Previous |

---

## Design Decisions Made

### 1. Deferred Saving
**Why**: Match amoCRM behavior, prevent data loss, give users control
**How**: Local state buffer + confirmation dialogs + batch save

### 2. Conditional Field Display
**Why**: Clean interface, avoid empty labels, scale with data
**How**: `{field && (<Component />)}` pattern throughout

### 3. Autocomplete + Create Pattern
**Why**: Fast data entry, no context switching
**How**: "+" button first in dropdown list, Enter to create

### 4. Section Visual Separation
**Why**: User requested "ะบะฐะบ ะฝะฐ ัะบัะธะฝะต ะฑัะดะตั ะฒะธะทัะฐะปัะฝะพ ะฟะพะฝััะฝัะผ ะทะพะฝั"
**How**: Border-top on section containers, spacing, uppercase labels

### 5. Auto-Company Assignment
**Why**: Logical default when creating contact from deal context
**How**: Pass deal's company_id to POST /api/contacts

---

## Pending Work Items

### High Priority
- [ ] Frontend UI ะดะปั ัะพะทะดะฐะฝะธั/ัะตะดะฐะบัะธัะพะฒะฐะฝะธั ะฒะพัะพะฝะพะบ
- [ ] Frontend UI ะดะปั ัะฟัะฐะฒะปะตะฝะธั ััะฐะฟะฐะผะธ ะฒะพัะพะฝะพะบ
- [ ] Implement detailed company cards (companies/[id] page)
- [ ] Implement detailed contact cards (contacts/[id] page)
- [ ] Add phone/email click handlers (call/email integrations)
- [ ] Replace alert() with toast notifications

### Medium Priority
- [ ] Add loading skeletons
- [ ] Implement activity log enhancements
- [ ] Add notes rich text editor
- [ ] Task completion UI improvements
- [ ] Dashboard analytics implementation
- [ ] ะะฐัััะพะนะบะฐ ะบะฐััะพะผะฝัั ะดะตัะพะปัะฝัั ััะฐะฟะพะฒ ะดะปั ะฐะบะบะฐัะฝัะพะฒ

### Low Priority
- [ ] Input debouncing on search fields
- [ ] Pagination for large lists
- [ ] Keyboard shortcuts
- [ ] Export/import functionality
- [ ] Advanced filtering

### Technical Debt
- [ ] Add request validation library (Zod)
- [ ] Add error boundaries
- [ ] Add rate limiting
- [ ] Optimize SQL queries with EXPLAIN ANALYZE
- [ ] Add unit tests
- [ ] Remove console.log from production code

---

## Key Files Modified Recently

| File | Lines | Last Change | Session |
|------|-------|-------------|---------|
| `src/lib/auth.ts` | 85 | Added getUserFromRequest() | Nov 19 |
| `src/app/api/auth/login/route.ts` | 73 | Added accountId to JWT | Nov 19 |
| `src/app/api/contacts/route.ts` | ~150 | account_id filtering | Nov 19 |
| `src/app/api/companies/route.ts` | ~150 | account_id filtering | Nov 19 |
| `src/app/api/deals/route.ts` | ~200 | account_id + field mapping | Nov 19 |
| `src/app/api/deals/[id]/route.ts` | ~300 | Fixed column names | Nov 19 |
| `src/app/api/pipelines/route.ts` | ~120 | account_id + POST endpoint | Nov 19 |
| `src/components/DealModal.tsx` | 981 | Removed contact_id | Nov 19 |
| PostgreSQL trigger | 10 | create_default_stages_for_pipeline | Nov 19 |
| `src/app/page.tsx` | 212 | Data safety fixes | Previous |
| `src/app/leads/page.tsx` | 280 | Array safety + initialization | Previous |

---

## Critical Information for Next Session

### โ๏ธ CRITICAL RULES - READ FIRST โ๏ธ

**ะะะะะะะ ะะ ะะกะขะะะะะะะะะ DEV SERVER!**
- Dev server ัะฐะฑะพัะฐะตั ะฝะฐ http://localhost:3000
- ะะกะะะะ ะธัะฟะพะปัะทัะน ะพัะดะตะปัะฝัะต ัะตัะผะธะฝะฐะปั ะดะปั ะบะพะผะฐะฝะด
- ะะะะะะะ ะฝะต ะธัะฟะพะปัะทัะน `pkill`, `Ctrl+C` ะฝะฐ ะฟัะพัะตััะต ั `next dev`
- ะะะะะะะ ะฝะต ัะฟัะฐัะธะฒะฐะน ัะฐะทัะตัะตะฝะธั - ะะะะะ ััะฐะทั

### System Requirements
**BEFORE STARTING ANY WORK:**
1. โ Check Docker container status: `docker ps | grep srm-postgres`
2. โ If not running: `docker start srm-postgres`
3. โ Wait 3 seconds for container to start
4. โ Verify data exists: `docker exec -it srm-postgres psql -U postgres -d srm -c "SELECT COUNT(*) FROM deals;"`

**Without running PostgreSQL container, ALL pages will be empty!**

### Data Safety Pattern (MANDATORY)
**ALWAYS use defensive programming for API data:**

```typescript
// โ CORRECT - Safe initialization
const data = await res.json()
setState(Array.isArray(data) ? data : [])

// โ WRONG - Will crash if API returns null
const data = await res.json()
setState(data)

// โ CORRECT - Safe rendering
{(array || []).map(item => ...)}

// โ WRONG - Will crash if array is undefined
{array.map(item => ...)}

// โ CORRECT - Safe property access
{(obj?.value || 0).toLocaleString()}

// โ WRONG - Will crash if value is undefined
{obj.value.toLocaleString()}
```

**This pattern prevents ALL "Cannot read properties of undefined" errors!**

### User Preferences
- Russian language throughout UI
- Exact amoCRM clone (visual and behavioral)
- Explicit save confirmations required
- No automatic saves
- Visual clarity paramount

### Code Style Patterns
- TypeScript strict mode
- Tailwind for all styling (no custom CSS)
- Direct SQL queries (not ORM abstractions)
- Server Components where possible
- Client Components for interactivity

### Testing Approach
- Manual testing via UI
- curl commands for API validation
- Check Chrome DevTools console for errors
- PostgreSQL direct queries to verify data

### Common Commands
```bash
# Start dev server (ะะกะะ ะะกะขะะะะะะะ)
npm run dev

# Access database
docker exec -it srm-postgres psql -U postgres -d srm

# Quick SQL query
docker exec srm-postgres psql -U postgres -d srm -c "SELECT * FROM pipelines;"

# Test API with curl
TOKEN=$(curl -s http://localhost:3000/api/auth/login -H 'Content-Type: application/json' -d '{"email":"admin@test.com","password":"parol123"}' | jq -r .token)
curl -s http://localhost:3000/api/pipelines -H "Cookie: auth_token=$TOKEN" | jq '.'

# Generate migration
npm run db:generate

# Apply migration
npm run db:migrate

# View database in browser
npm run db:studio
```

### Multi-Tenancy Architecture
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ   ACCOUNT (ะพัะณะฐะฝะธะทะฐัะธั)             โ
โ   โโโ account_id: UUID              โ
โ   โโโ name: string                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
              โโโ USERS (account_id FK)
              โโโ COMPANIES (account_id FK)
              โโโ CONTACTS (account_id FK)
              โโโ PIPELINES (account_id FK)
              โ   โโโ STAGES (pipeline_id FK)
              โ       โโโ DEALS (stage_id FK)
              โ           โโโ DEAL_CONTACTS (deal_id, contact_id)
              โโโ TASKS (account_id FK)
              โโโ NOTES (account_id FK)
              โโโ ACTIVITY_LOGS (account_id FK)
```

**ะัะฐะฒะธะปะฐ ะธะทะพะปััะธะธ:**
1. ะะกะ API routes ะะะฏะะะขะะะฌะะ ัะธะปัััััั ะฟะพ `account_id`
2. JWT ัะพะบะตะฝ ะะกะะะะ ัะพะดะตัะถะธั `{ userId, accountId, email }`
3. ะคัะฝะบัะธั `getUserFromRequest()` ะธัะฟะพะปัะทัะตััั ะดะปั ะธะทะฒะปะตัะตะฝะธั ะบะพะฝัะตะบััะฐ
4. PostgreSQL trigger ะฐะฒัะพะผะฐัะธัะตัะบะธ ัะพะทะดะฐะตั 3 ะดะตัะพะปัะฝัั ััะฐะฟะฐ ะฟัะธ ัะพะทะดะฐะฝะธะธ ะฒะพัะพะฝะบะธ

---

## Critical Patterns to Remember

### 1. Next.js 15 Params Pattern
```typescript
// ALWAYS await params in API routes
export async function GET(
  request: Request,
  { params }: { params: Promise<{ id: string }> }
) {
  const { id } = await params  // MUST await
  // ...
}
```

### 2. stopPropagation Placement
```typescript
// โ WRONG - Menu won't open
<button onClick={(e) => {
  e.stopPropagation()
  setActiveMenu('menu-1')
}}>Open</button>

// โ RIGHT - Only on menu body
<button onClick={() => setActiveMenu('menu-1')}>Open</button>
<div onClick={(e) => e.stopPropagation()}>Menu content</div>
```

### 3. Transactional Edit Flow
```typescript
// 1. Load initial data
useEffect(() => fetchDeal(), [dealId])

// 2. Track changes locally
function updateField(field, value) {
  setEditForm(prev => ({ ...prev, [field]: value }))
  setHasChanges(true)
}

// 3. Save on explicit action
async function handleSave() {
  await fetch('/api/deals/' + dealId, {
    method: 'PUT',
    body: JSON.stringify(editForm)
  })
  setHasChanges(false)
  await fetchDeal() // Reload
}

// 4. Confirm before exit
function handleClose() {
  if (hasChanges) {
    if (!confirm('ะะตัะพััะฐะฝะตะฝะฝัะต ะธะทะผะตะฝะตะฝะธั ะฑัะดัั ะฟะพัะตััะฝั')) return
  }
  onClose()
}
```

### 4. Autocomplete Pattern
```typescript
const [searchTerm, setSearchTerm] = useState('')
const [showSearch, setShowSearch] = useState(false)

const filtered = items.filter(item => 
  item.name.toLowerCase().includes(searchTerm.toLowerCase())
)

<input 
  value={searchTerm}
  onChange={(e) => {
    setSearchTerm(e.target.value)
    setShowSearch(true)
  }}
  onBlur={() => setTimeout(() => setShowSearch(false), 200)}
/>

{showSearch && (
  <div>
    <button onClick={() => handleCreate(searchTerm)}>
      + ะกะพะทะดะฐัั "{searchTerm}"
    </button>
    {filtered.map(item => (
      <button onClick={() => handleSelect(item)}>
        {item.name}
      </button>
    ))}
  </div>
)}
```

### 5. Subscription/Feature Access Pattern
**File**: `/src/lib/subscription.ts`

**ะัะฟะพะปัะทะพะฒะฐะฝะธะต ะฒ ะบะพะผะฟะพะฝะตะฝัะฐั:**
```typescript
// ะัะพะฒะตัะบะฐ ะดะพัััะฟะฐ ะบ ััะฝะบัะธะธ
const [hasAccess, setHasAccess] = useState(false)

useEffect(() => {
  async function checkAccess() {
    const res = await fetch('/api/account/check-feature', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ feature: 'chat_search' })
    })
    const data = await res.json()
    setHasAccess(data.hasAccess)
  }
  checkAccess()
}, [])

// ะ UI ะฟะพะบะฐะทัะฒะฐะตะผ ัะฐะทะฝัะน ะบะพะฝัะตะฝั
{hasAccess ? (
  <SearchInput />
) : (
  <div>
    ะคัะฝะบัะธั ะดะพัััะฟะฝะฐ ะฒ ัะฐัะธัะต 
    <a href="/pricing">ยซะัะพัะตััะธะพะฝะฐะปัะฝัะนยป</a>
  </div>
)}
```

**ะ API routes:**
```typescript
import { hasFeatureAccess } from '@/lib/subscription'

const user = await getUserFromRequest(request)
const hasAccess = await hasFeatureAccess(user.accountId, 'chat_search')

if (!hasAccess) {
  return NextResponse.json({ 
    error: 'Upgrade required',
    requiredPlan: 'professional'
  }, { status: 403 })
}
```

**ะะพัััะฟะฝัะต ััะฝะบัะธะธ:**
- `chat_search` - ะะพะธัะบ ะฟะพ ัะพะพะฑัะตะฝะธัะผ (Professional+)
- `advanced_filters` - ะะฐััะธัะตะฝะฝัะต ัะธะปัััั (Professional+)
- `api_access` - API ะดะพัััะฟ (Professional+)
- `custom_fields` - ะะพะปัะทะพะฒะฐัะตะปััะบะธะต ะฟะพะปั (Professional+)
- `advanced_analytics` - ะัะพะดะฒะธะฝััะฐั ะฐะฝะฐะปะธัะธะบะฐ (Professional+)
- `bulk_operations` - ะะฐััะพะฒัะต ะพะฟะตัะฐัะธะธ (Business)
- `automation` - ะะฒัะพะผะฐัะธะทะฐัะธั (Business)
- `email_integration` - Email ะธะฝัะตะณัะฐัะธั (Business)
- `priority_support` - ะัะธะพัะธัะตัะฝะฐั ะฟะพะดะดะตัะถะบะฐ (Business)
- `white_label` - White-label (Business)
