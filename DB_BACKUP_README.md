# Database Backup & Restore System

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ backup/restore –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ Supabase –ë–î.

## üìã –§–∞–π–ª—ã:

- `backup_before_migration.sh` - –°–æ–∑–¥–∞–Ω–∏–µ backup
- `restore_from_backup.sh` - –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ backup
- `safe_db_change.sh` - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π backup + –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ SQL + –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–∫–∞—Ç–∞
- `backups/` - –ü–∞–ø–∫–∞ —Å–æ –≤—Å–µ–º–∏ backup'–∞–º–∏

---

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
# 1. –°–æ–∑–¥–∞–π SQL —Ñ–∞–π–ª —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, add_priority.sql)
# 2. –ó–∞–ø—É—Å—Ç–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ
bash safe_db_change.sh add_priority.sql

# –°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
# - –°–æ–∑–¥–∞—Å—Ç backup
# - –ü—Ä–∏–º–µ–Ω–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è
# - –ü–æ–∫–∞–∂–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –†—É—á–Ω–æ–π –∫–æ–Ω—Ç—Ä–æ–ª—å

```bash
# 1. –°–æ–∑–¥–∞—Ç—å backup
bash backup_before_migration.sh

# 2. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—Ä—É—á–Ω—É—é (—á–µ—Ä–µ–∑ Supabase Dashboard –∏–ª–∏ psql)

# 3. –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫ - –æ—Ç–∫–∞—Ç–∏—Ç—å
bash restore_from_backup.sh
```

---

## üîÑ –û—Ç–∫–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π:

### –û—Ç–∫–∞—Ç–∏—Ç—å –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É backup:
```bash
bash restore_from_backup.sh
```

### –û—Ç–∫–∞—Ç–∏—Ç—å –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É backup:
```bash
bash restore_from_backup.sh backups/supabase_backup_2025-11-16_14-30-00.sql
```

---

## üì¶ –ß—Ç–æ –≤–∫–ª—é—á–∞–µ—Ç backup:

- ‚úÖ –í—Å–µ —Ç–∞–±–ª–∏—Ü—ã (—Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
- ‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ (1000+ —Å–¥–µ–ª–æ–∫ —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è)
- ‚úÖ –ò–Ω–¥–µ–∫—Å—ã
- ‚úÖ –¢—Ä–∏–≥–≥–µ—Ä—ã
- ‚úÖ –§—É–Ω–∫—Ü–∏–∏
- ‚úÖ Constraints

## ‚ö†Ô∏è –ß—Ç–æ –ù–ï –≤–∫–ª—é—á–∞–µ—Ç:

- ‚ùå –†–æ–ª–∏ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (Supabase —É–ø—Ä–∞–≤–ª—è–µ—Ç —ç—Ç–∏–º)
- ‚ùå Extensions (pgcrypto –∏ –¥—Ä. - —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

---

## üí° –ü—Ä–∏–º–µ—Ä—ã:

### –î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É –≤ —Ç–∞–±–ª–∏—Ü—É:
```bash
# –°–æ–∑–¥–∞–π —Ñ–∞–π–ª add_priority.sql:
ALTER TABLE deals ADD COLUMN priority VARCHAR(32) DEFAULT 'medium';

# –ü—Ä–∏–º–µ–Ω–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ:
bash safe_db_change.sh add_priority.sql
```

### –ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø–æ–ª–Ω—É—é –º–∏–≥—Ä–∞—Ü–∏—é:
```bash
bash safe_db_change.sh supabase_migration.sql
```

### –û—Ç–∫–∞—Ç–∏—Ç—å –µ—Å–ª–∏ –Ω–∞–∫–æ—Å—è—á–∏–ª:
```bash
bash restore_from_backup.sh
# –ü–æ–¥—Ç–≤–µ—Ä–¥–∏ –≤–≤–æ–¥ "yes"
```

---

## üéØ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. **backup_before_migration.sh**:
   - –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ Supabase —á–µ—Ä–µ–∑ `pg_dump`
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–æ–ª–Ω—ã–π –¥–∞–º–ø –≤ `backups/supabase_backup_TIMESTAMP.sql`
   - –ó–∞–ø–æ–º–∏–Ω–∞–µ—Ç –ø—É—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ backup –≤ `backups/.last_backup`

2. **safe_db_change.sh**:
   - –°–æ–∑–¥–∞–µ—Ç backup –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
   - –ü—Ä–∏–º–µ–Ω—è–µ—Ç SQL —á–µ—Ä–µ–∑ `psql`
   - –ï—Å–ª–∏ SQL —É–ø–∞–ª —Å –æ—à–∏–±–∫–æ–π ‚Üí –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –æ—Ç–∫–∞—Ç–∏—Ç—å

3. **restore_from_backup.sh**:
   - –£–¥–∞–ª—è–µ—Ç —Ç–µ–∫—É—â—É—é —Å—Ö–µ–º—É `public` (–≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã)
   - –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∏–∑ backup
   - –í—Å–µ –¥–∞–Ω–Ω—ã–µ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –∫ –º–æ–º–µ–Ω—Ç—É backup

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:

- Backup —Ñ–∞–π–ª—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ `backups/`
- –ù–ï –∫–æ–º–º–∏—Ç—å backup'—ã –≤ Git (—Å–æ–¥–µ—Ä–∂–∞—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
- –ü–∞—Ä–æ–ª—å –æ—Ç –ë–î –≤ —Å–∫—Ä–∏–ø—Ç–∞—Ö (—Ç–æ–ª—å–∫–æ –¥–ª—è dev, –≤ production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å env vars)

---

## üìù –°—Ç—Ä—É–∫—Ç—É—Ä–∞ backup —Ñ–∞–π–ª–∞:

```
backups/
‚îú‚îÄ‚îÄ supabase_backup_2025-11-16_14-30-00.sql  ‚Üê Backup –ø–µ—Ä–µ–¥ migration
‚îú‚îÄ‚îÄ supabase_backup_2025-11-16_15-45-12.sql  ‚Üê Backup –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º priority
‚îú‚îÄ‚îÄ supabase_backup_2025-11-16_16-20-33.sql  ‚Üê Backup –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º —Ç–∞–±–ª–∏—Ü—ã
‚îî‚îÄ‚îÄ .last_backup                              ‚Üê –ü—É—Ç—å –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É backup
```

---

## ‚úÖ Workflow:

```
1. –•–æ—á–µ—à—å –∏–∑–º–µ–Ω–∏—Ç—å –ë–î
   ‚Üì
2. bash safe_db_change.sh my_changes.sql
   ‚Üì
3. –ü—Ä–æ–≤–µ—Ä—è–µ—à—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
   ‚Üì
4–∞. –í—Å—ë –û–ö ‚Üí —Ä–∞–±–æ—Ç–∞–µ—à—å –¥–∞–ª—å—à–µ
4–±. –ù–∞–∫–æ—Å—è—á–∏–ª ‚Üí bash restore_from_backup.sh ‚Üí –≤–µ—Ä–Ω—É–ª—Å—è –∫ —à–∞–≥—É 1
```
